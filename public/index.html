<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FORGE Health ‚Äî Command Center</title>
<link rel="icon" type="image/svg+xml" href="logo.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e17; --bg-card: #111827; --bg-card-hover: #1a2235; --bg-surface: #0f1520;
    --border: #1e293b; --border-hover: #334155;
    --text: #e2e8f0; --text-dim: #94a3b8; --text-muted: #64748b;
    --accent: #3b82f6; --accent-glow: rgba(59,130,246,0.15); --accent-hover: #60a5fa;
    --success: #10b981; --success-bg: rgba(16,185,129,0.1);
    --warning: #f59e0b; --warning-bg: rgba(245,158,11,0.1);
    --danger: #ef4444; --danger-bg: rgba(239,68,68,0.1);
    --purple: #8b5cf6; --purple-bg: rgba(139,92,246,0.1);
    --forge-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    --radius: 12px; --radius-sm: 8px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Inter',-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  .app { display:flex; height:100vh; }
  
  /* Sidebar */
  .sidebar { width:250px; background:var(--bg-surface); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; }
  .sidebar-brand { padding:20px 18px; border-bottom:1px solid var(--border); }
  .sidebar-brand h1 { font-family:'Space Grotesk',sans-serif; font-size:1.2rem; font-weight:700; background:var(--forge-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .sidebar-brand span { font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; display:block; margin-top:2px; }
  .sidebar-nav { padding:10px 8px; flex:1; overflow-y:auto; }
  .nav-section { font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; padding:14px 10px 4px; }
  .nav-item { display:flex; align-items:center; gap:9px; padding:9px 11px; border-radius:var(--radius-sm); cursor:pointer; color:var(--text-dim); font-size:0.82rem; transition:all 0.15s; }
  .nav-item:hover { background:var(--bg-card); color:var(--text); }
  .nav-item.active { background:var(--accent-glow); color:var(--accent); font-weight:500; }
  .nav-item .icon { font-size:0.95rem; width:20px; text-align:center; }
  .nav-badge { margin-left:auto; background:var(--accent); color:white; font-size:0.6rem; padding:2px 7px; border-radius:10px; font-weight:600; }
  .sidebar-footer { padding:14px 18px; border-top:1px solid var(--border); }
  .mira-status { display:flex; align-items:center; gap:10px; }
  .mira-avatar { width:34px; height:34px; background:var(--forge-gradient); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1rem; }
  .mira-info h3 { font-size:0.82rem; font-weight:600; }
  .mira-info p { font-size:0.68rem; color:var(--success); display:flex; align-items:center; gap:4px; }
  .mira-info p::before { content:''; width:6px; height:6px; background:var(--success); border-radius:50%; }

  /* Main */
  .main { flex:1; display:flex; flex-direction:column; overflow:hidden; }
  .header { padding:18px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .header-left h2 { font-family:'Space Grotesk',sans-serif; font-size:1.3rem; font-weight:600; }
  .header-left p { font-size:0.78rem; color:var(--text-muted); margin-top:2px; }
  .header-right { display:flex; gap:10px; }
  .btn { background:var(--bg-card); border:1px solid var(--border); color:var(--text-dim); padding:7px 14px; border-radius:var(--radius-sm); font-size:0.78rem; cursor:pointer; transition:all 0.15s; font-family:inherit; }
  .btn:hover { border-color:var(--border-hover); color:var(--text); }
  .btn.primary { background:var(--accent); border-color:var(--accent); color:white; }
  .btn.primary:hover { background:var(--accent-hover); }

  .content { flex:1; overflow-y:auto; padding:20px 24px; }

  /* Stats */
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:20px; }
  .stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:16px 18px; transition:all 0.2s; }
  .stat-card:hover { border-color:var(--border-hover); }
  .stat-label { font-size:0.68rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px; }
  .stat-value { font-family:'Space Grotesk',sans-serif; font-size:1.7rem; font-weight:700; }
  .stat-sub { font-size:0.68rem; color:var(--success); margin-top:3px; }

  /* Kanban */
  .kanban { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:20px; }
  .kanban-col { background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius); display:flex; flex-direction:column; min-height:250px; }
  .kanban-header { padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .kanban-title { font-size:0.78rem; font-weight:600; display:flex; align-items:center; gap:8px; }
  .kanban-count { font-size:0.6rem; background:var(--bg-card); color:var(--text-muted); padding:2px 7px; border-radius:10px; }
  .kanban-cards { padding:8px; flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:6px; }
  .k-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 12px; cursor:pointer; transition:all 0.15s; position:relative; }
  .k-card:hover { border-color:var(--border-hover); background:var(--bg-card-hover); }
  .k-card.urgent { border-left:3px solid var(--danger); }
  .k-card.high { border-left:3px solid var(--warning); }
  .k-card-title { font-size:0.78rem; font-weight:500; margin-bottom:5px; line-height:1.3; }
  .k-card-meta { display:flex; gap:5px; flex-wrap:wrap; }
  .k-tag { font-size:0.6rem; padding:2px 7px; border-radius:4px; font-weight:500; }
  .k-tag.cio { background:var(--accent-glow); color:var(--accent); }
  .k-tag.lumen,.k-tag.sdk { background:var(--purple-bg); color:var(--purple); }
  .k-tag.strategy,.k-tag.gtm,.k-tag.brand { background:var(--warning-bg); color:var(--warning); }
  .k-tag.outreach,.k-tag.ops { background:var(--success-bg); color:var(--success); }
  .k-tag.urgent,.k-tag.priority { background:var(--danger-bg); color:var(--danger); }
  .k-tag.infra,.k-tag.product { background:var(--purple-bg); color:var(--purple); }
  .k-card-date { font-size:0.6rem; color:var(--text-muted); margin-top:6px; }

  /* Bottom Grid */
  .bottom-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .panel { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); }
  .panel-header { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .panel-header h3 { font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:8px; }
  .panel-body { padding:12px 16px; max-height:350px; overflow-y:auto; }

  .activity-item { display:flex; gap:10px; padding:8px 0; border-bottom:1px solid var(--border); }
  .activity-item:last-child { border-bottom:none; }
  .activity-icon { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.75rem; flex-shrink:0; background:var(--bg-surface); }
  .activity-text { font-size:0.78rem; line-height:1.4; }
  .activity-text strong { font-weight:600; }
  .activity-time { font-size:0.62rem; color:var(--text-muted); margin-top:1px; }

  .cio-item { display:flex; align-items:center; justify-content:space-between; padding:9px 0; border-bottom:1px solid var(--border); }
  .cio-item:last-child { border-bottom:none; }
  .cio-info h4 { font-size:0.8rem; font-weight:500; }
  .cio-info p { font-size:0.68rem; color:var(--text-muted); }
  .cio-status { font-size:0.62rem; padding:3px 9px; border-radius:4px; font-weight:500; }
  .cio-status.prospect { background:var(--accent-glow); color:var(--accent); }
  .cio-status.researching,.cio-status.contacted { background:var(--warning-bg); color:var(--warning); }
  .cio-status.meeting,.cio-status.proposal { background:var(--success-bg); color:var(--success); }
  .cio-status.nurture { background:var(--purple-bg); color:var(--purple); }
  .cio-status.won { background:var(--success-bg); color:var(--success); }

  /* Modal */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:100; align-items:center; justify-content:center; }
  .modal-overlay.show { display:flex; }
  .modal { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); width:480px; max-width:90vw; max-height:80vh; overflow-y:auto; }
  .modal-head { padding:18px 20px; border-bottom:1px solid var(--border); font-weight:600; font-size:0.95rem; display:flex; justify-content:space-between; align-items:center; }
  .modal-close { cursor:pointer; font-size:1.2rem; color:var(--text-muted); background:none; border:none; }
  .modal-body { padding:18px 20px; }
  .modal-body label { display:block; font-size:0.75rem; color:var(--text-dim); margin-bottom:4px; margin-top:12px; }
  .modal-body label:first-child { margin-top:0; }
  .modal-body input,.modal-body select,.modal-body textarea { width:100%; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); padding:9px 12px; border-radius:var(--radius-sm); font-family:inherit; font-size:0.82rem; }
  .modal-body textarea { min-height:80px; resize:vertical; }
  .modal-body input:focus,.modal-body select:focus,.modal-body textarea:focus { outline:none; border-color:var(--accent); }
  .modal-foot { padding:14px 20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }

  /* Quick Panel (slide-out) */
  .quick-panel { position:fixed; top:0; right:-480px; width:460px; height:100vh; background:var(--bg-card); border-left:1px solid var(--border); z-index:150; transition:right 0.25s ease; display:flex; flex-direction:column; box-shadow:-4px 0 20px rgba(0,0,0,0.3); }
  .quick-panel.open { right:0; }
  .quick-panel-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .quick-panel-header h3 { font-size:0.95rem; font-weight:600; display:flex; align-items:center; gap:8px; }
  .quick-panel-close { background:none; border:none; color:var(--text-muted); font-size:1.4rem; cursor:pointer; padding:4px 8px; border-radius:4px; }
  .quick-panel-close:hover { background:var(--bg-surface); color:var(--text); }
  .quick-panel-body { flex:1; overflow-y:auto; padding:16px 20px; display:flex; flex-direction:column; }
  .quick-panel-footer { padding:12px 20px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:space-between; flex-shrink:0; }
  .quick-panel-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:140; opacity:0; pointer-events:none; transition:opacity 0.25s; }
  .quick-panel-overlay.open { opacity:1; pointer-events:auto; }
  .qp-field { margin-bottom:14px; }
  .qp-field label { display:block; font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:5px; }
  .qp-field input, .qp-field select, .qp-field textarea { width:100%; background:var(--bg-surface); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:var(--radius-sm); font-family:inherit; font-size:0.85rem; }
  .qp-field textarea { min-height:100px; resize:vertical; }
  .qp-field input:focus, .qp-field select:focus, .qp-field textarea:focus { outline:none; border-color:var(--accent); }
  .qp-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .qp-tag { font-size:0.7rem; padding:4px 10px; border-radius:4px; cursor:pointer; transition:all 0.15s; }
  .qp-status-row { display:flex; gap:6px; flex-wrap:wrap; }
  .qp-status-btn { flex:1; min-width:70px; padding:8px 10px; border:1px solid var(--border); background:var(--bg-surface); color:var(--text-dim); border-radius:var(--radius-sm); font-size:0.75rem; cursor:pointer; text-align:center; transition:all 0.15s; }
  .qp-status-btn:hover { border-color:var(--border-hover); color:var(--text); }
  .qp-status-btn.active { background:var(--accent); border-color:var(--accent); color:white; }
  .qp-meta { font-size:0.7rem; color:var(--text-muted); padding:10px 0; border-top:1px solid var(--border); margin-top:14px; }

  /* Sidebar Chat */
  .sidebar-chat { border-top:1px solid var(--border); display:flex; flex-direction:column; height:350px; flex-shrink:0; }
  .sidebar-chat-header { padding:8px 14px; font-size:0.78rem; font-weight:600; color:var(--text); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
  .sidebar-chat-frame { flex:1; border:none; width:100%; min-height:0; border-radius:0 0 0 0; }
  .mira-dot-sm { width:8px; height:8px; border-radius:50%; transition:background 0.3s; }
  .mira-dot-sm.idle { background:#64748b; }
  .mira-dot-sm.working { background:var(--success); animation:pulse-dot 1.5s ease-in-out infinite; }
  .mira-dot-sm.offline { background:var(--danger); }
  @keyframes pulse-dot { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
  @keyframes miraGlow { 0% { box-shadow:0 0 20px var(--accent-glow); } 50% { box-shadow:0 0 30px var(--accent-glow); } 100% { box-shadow:0 0 10px var(--accent-glow); } }

  /* Advisor Ticker */
  .advisor-ticker { background:linear-gradient(90deg, rgba(59,130,246,0.08) 0%, rgba(139,92,246,0.08) 100%); border-bottom:1px solid var(--border); padding:0; overflow:hidden; min-height:36px; display:flex; align-items:center; flex-shrink:0; position:relative; }
  .advisor-ticker::before { content:'üîÆ'; position:absolute; left:12px; z-index:2; font-size:0.8rem; }
  .ticker-track { display:flex; align-items:center; padding-left:36px; padding-right:16px; width:100%; }
  .ticker-text { font-size:0.75rem; color:var(--text-dim); font-style:italic; line-height:1.4; padding:8px 0; }
  .ticker-text strong { color:var(--accent); font-style:normal; font-weight:600; }
  .ticker-fade-in { animation: tickerFadeIn 0.6s ease-out; }
  @keyframes tickerFadeIn { 0% { opacity:0; transform:translateY(8px); } 100% { opacity:1; transform:translateY(0); } }

  @media (max-width:1200px) {
    .kanban { grid-template-columns:repeat(2,1fr); }
    .stats-row { grid-template-columns:repeat(2,1fr); }
  }
  @media (max-width:768px) {
    .sidebar { display:none; }
    .kanban { grid-template-columns:1fr; }
    .stats-row { grid-template-columns:1fr 1fr; }
    .bottom-grid { grid-template-columns:1fr; }
    .chat-panel { width:calc(100vw - 32px); right:16px; bottom:80px; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-brand">
      <img src="logo.png" alt="FORGE Health" style="height:56px;margin-bottom:4px;">
      <span>Command Center</span>
    </div>
    <div class="sidebar-nav">
      <div class="nav-section">Focus</div>
      <div class="nav-item active" onclick="showPage('dashboard',this)"><span class="icon">üöÄ</span> Activation Bridge</div>
      <div class="nav-item" onclick="showPage('briefing',this)"><span class="icon">üì∞</span> Daily Briefing</div>
      <div class="nav-section">Sales</div>
      <div class="nav-item" onclick="showPage('sales_pipeline',this)"><span class="icon">üí∞</span> Pipeline <span class="nav-badge" id="pipeline-badge">0</span></div>
      <div class="nav-item" onclick="showPage('pipeline',this)"><span class="icon">üéØ</span> CIO Targets <span class="nav-badge" id="cio-badge">0</span></div>
      <div class="nav-item" onclick="showPage('leads',this)"><span class="icon">üî•</span> Leads <span class="nav-badge" id="leads-badge">0</span></div>
      <div class="nav-section">Marketing</div>
      <div class="nav-item" onclick="showPage('linkedin',this)"><span class="icon">üíº</span> LinkedIn</div>
      <div class="nav-item" onclick="showPage('content',this)"><span class="icon">‚úçÔ∏è</span> Content</div>
      <div class="nav-item" onclick="showPage('conferences',this)"><span class="icon">üé§</span> Conferences</div>
      <div class="nav-section">Workspace</div>
      <div class="nav-item" onclick="showPage('notes',this)"><span class="icon">üìù</span> Notes</div>
      <div class="nav-item" onclick="showPage('archived',this)"><span class="icon">üì¶</span> Archived</div>
      <div class="nav-section">Development</div>
      <div class="nav-item" onclick="showPage('lumen',this)"><span class="icon">üí°</span> Lumen App</div>
      <div class="nav-item" onclick="showPage('sdk',this)"><span class="icon">üîß</span> Lumen SDK</div>
    </div>
    <div class="sidebar-chat">
      <div class="sidebar-chat-header">
        <span>üîÆ Mira</span>
        <span class="mira-dot-sm idle" id="miraDotSm"></span>
      </div>
      <div id="chatMessages" style="flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:6px;"></div>
      <div style="padding:8px 10px;border-top:1px solid var(--border);display:flex;gap:6px;">
        <input id="chatInput" type="text" placeholder="Message Mira..." style="flex:1;background:var(--bg-card);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:var(--radius-sm);font-size:0.78rem;font-family:inherit;" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn primary" style="padding:6px 12px;font-size:0.75rem;" onclick="sendChat()">‚Üí</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="advisor-ticker" id="advisorTicker">
      <div class="ticker-track" id="tickerTrack"></div>
    </div>
    <div class="header">
      <div class="header-left">
        <h2 id="page-title">Activation Bridge</h2>
        <p id="page-sub"></p>
      </div>
      <!-- Global Search -->
      <div style="position:relative;flex:1;max-width:400px;margin:0 20px;">
        <input type="text" id="globalSearch" placeholder="Search everything... (‚åòK)" 
          oninput="handleGlobalSearch(this.value)"
          onfocus="document.getElementById('searchResults').style.display='block'"
          style="width:100%;background:var(--bg-surface);border:1px solid var(--border);color:var(--text);padding:8px 14px 8px 36px;border-radius:var(--radius-sm);font-size:0.82rem;">
        <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:0.9rem;">üîç</span>
        <div id="searchResults" style="display:none;position:absolute;top:100%;left:0;right:0;margin-top:6px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);max-height:400px;overflow-y:auto;z-index:200;box-shadow:0 8px 30px rgba(0,0,0,0.4);"></div>
      </div>
      <div class="header-right">
        <button class="btn primary" onclick="openNewTask()">+ New Task</button>
      </div>
    </div>
    <div class="content" id="content"></div>
  </div>
</div>

<!-- Floating elements removed ‚Äî chat is now in sidebar -->

<!-- New Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-head">New Task <button class="modal-close" onclick="closeModal('taskModal')">‚úï</button></div>
    <div class="modal-body">
      <label>Title</label>
      <input id="taskTitle" placeholder="What needs to be done?">
      <label>Description</label>
      <textarea id="taskDesc" placeholder="Optional details..."></textarea>
      <label>Status</label>
      <select id="taskStatus">
        <option value="todo">To Do</option>
        <option value="in_progress">In Progress</option>
        <option value="backlog">Ideas / Backlog</option>
      </select>
      <label>Priority</label>
      <select id="taskPriority">
        <option value="normal">Normal</option>
        <option value="high">High</option>
        <option value="urgent">Urgent</option>
        <option value="low">Low</option>
      </select>
      <label>Tags (comma-separated)</label>
      <input id="taskTags" placeholder="e.g. CIO Target, Strategy">
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal('taskModal')">Cancel</button>
      <button class="btn primary" onclick="saveTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- New Lead Modal -->
<div class="modal-overlay" id="leadModal">
  <div class="modal">
    <div class="modal-head">Capture Lead <button class="modal-close" onclick="closeModal('leadModal')">‚úï</button></div>
    <div class="modal-body">
      <label>Name *</label>
      <input id="leadName" placeholder="Jane Smith">
      <label>Title</label>
      <input id="leadTitle" placeholder="CIO, VP Digital, etc.">
      <label>Organization *</label>
      <input id="leadOrg" placeholder="Hospital / Health System">
      <label>Email</label>
      <input id="leadEmail" placeholder="jane@hospital.ca">
      <label>Phone</label>
      <input id="leadPhone" placeholder="+1 416 555 1234">
      <label>Interest Level</label>
      <select id="leadInterest">
        <option value="Hot">üî• Hot</option>
        <option value="Warm" selected>‚òÄÔ∏è Warm</option>
        <option value="Cool">‚ùÑÔ∏è Cool</option>
      </select>
      <label>Event / Source</label>
      <input id="leadSource" placeholder="e-Health 2026, HIMSS, etc.">
      <label>Notes</label>
      <textarea id="leadNotes" placeholder="Key takeaways, follow-up items..."></textarea>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="closeModal('leadModal')">Cancel</button>
      <button class="btn primary" onclick="saveLead()">Save Lead</button>
    </div>
  </div>
</div>

<script>
const API = '';
// chat embedded in sidebar

// ‚îÄ‚îÄ Data ‚îÄ‚îÄ
async function api(path, opts) {
  const r = await fetch(API + path, { headers:{'Content-Type':'application/json'}, ...opts });
  return r.json();
}

// ‚îÄ‚îÄ Pages ‚îÄ‚îÄ
function showPage(page, el) {
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  if(page==='dashboard') loadDashboard();
  else if(page==='pipeline') loadPipeline();
  else if(page==='sales_pipeline') loadSalesPipeline();
  else if(page==='briefing') loadBriefing();
  else if(page==='leads') loadLeads();
  else if(page==='notes') loadNotes();
  else if(page==='archived') loadArchived();
  else { document.getElementById('page-title').textContent=page; document.getElementById('content').innerHTML='<p style="color:var(--text-muted);padding:40px;">Coming soon...</p>'; }
}

async function loadDashboard() {
  document.getElementById('page-title').textContent = 'Activation Bridge';
  const now = new Date();
  document.getElementById('page-sub').textContent = now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  
  let stats, tasks, activity, cios;
  try {
    [stats, tasks, activity, cios] = await Promise.all([
      api('/api/stats'), api('/api/tasks'), api('/api/activity?limit=8'), api('/api/cio')
    ]);
  } catch(e) {
    console.error('Dashboard load error:', e);
    document.getElementById('content').innerHTML = `<div style="padding:40px;color:var(--danger);">Error loading dashboard: ${e.message}</div>`;
    return;
  }
  if (!stats || !tasks || !activity || !cios) {
    document.getElementById('content').innerHTML = '<div style="padding:40px;color:var(--warning);">Loading data...</div>';
    return;
  }
  
  const confDate = new Date('2026-05-31');
  const daysToConf = Math.ceil((confDate - now)/(1000*60*60*24));
  document.getElementById('cio-badge').textContent = stats.totalCIOs;

  const tasksByStatus = {todo:[],in_progress:[],done:[],backlog:[]};
  tasks.forEach(t => { if(tasksByStatus[t.status]) tasksByStatus[t.status].push(t); });

  document.getElementById('content').innerHTML = `
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Target CIOs</div><div class="stat-value" style="color:var(--accent)">${stats.totalCIOs}</div><div class="stat-sub">${stats.activeOutreach} in active outreach</div></div>
      <div class="stat-card"><div class="stat-label">Active Tasks</div><div class="stat-value" style="color:var(--warning)">${(stats.tasks.todo||0)+(stats.tasks.in_progress||0)}</div><div class="stat-sub">${stats.tasks.in_progress||0} in progress</div></div>
      <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" style="color:var(--success)">${stats.tasks.done||0}</div><div class="stat-sub">Tasks done</div></div>
      <div class="stat-card"><div class="stat-label">Next Conference</div><div class="stat-value" style="color:var(--purple)">${daysToConf}<span style="font-size:0.7rem;font-weight:400;color:var(--text-muted)"> days</span></div><div class="stat-sub">e-Health 2026 ¬∑ Toronto ¬∑ May 31</div></div>
    </div>
    <div class="kanban">
      ${renderKanbanCol('üìã To Do','todo',tasksByStatus.todo)}
      ${renderKanbanCol('‚ö° In Progress','in_progress',tasksByStatus.in_progress)}
      ${renderKanbanCol('‚úÖ Done','done',tasksByStatus.done)}
      ${renderKanbanCol('üí° Ideas','backlog',tasksByStatus.backlog)}
    </div>
    <div class="bottom-grid">
      <div class="panel">
        <div class="panel-header"><h3>üì° Recent Activity</h3></div>
        <div class="panel-body">${activity.map(a => `
          <div class="activity-item">
            <div class="activity-icon">${a.icon}</div>
            <div><div class="activity-text"><strong>${esc(a.title)}</strong>${a.description?' ‚Äî '+esc(a.description):''}</div><div class="activity-time">${fmtDate(a.created_at)}</div></div>
          </div>`).join('')}
        </div>
      </div>
      <div class="panel">
        <div class="panel-header"><h3>üéØ CIO Pipeline</h3></div>
        <div class="panel-body">${cios.slice(0,6).map(c => `
          <div class="cio-item">
            <div class="cio-info"><h4>${esc(c.organization)}</h4><p>${esc(c.location)}</p></div>
            <span class="cio-status ${c.status}">${c.status}</span>
          </div>`).join('')}
        </div>
      </div>
    </div>`;
}

function renderKanbanCol(title, status, cards) {
  const urgentCount = cards.filter(c => c.priority === 'urgent').length;
  const miraCount = cards.filter(c => c.mira_unread).length;
  return `<div class="kanban-col">
    <div class="kanban-header">
      <div class="kanban-title">${title} <span class="kanban-count">${cards.length}</span></div>
      <div style="display:flex;gap:4px;">
        ${miraCount ? `<span style="background:var(--accent);color:white;font-size:0.55rem;padding:2px 6px;border-radius:8px;" title="${miraCount} with Mira updates">üîÆ ${miraCount}</span>` : ''}
        ${urgentCount ? `<span style="background:var(--danger);color:white;font-size:0.55rem;padding:2px 6px;border-radius:8px;" title="${urgentCount} urgent">üö® ${urgentCount}</span>` : ''}
      </div>
    </div>
    <div class="kanban-cards" data-status="${status}" ondrop="dropCard(event)" ondragover="event.preventDefault()">
      ${cards.map(c => {
        let tags = []; try { const _t = JSON.parse(c.tags||'[]'); tags = Array.isArray(_t) ? _t : typeof _t === 'string' ? _t.split(',').map(s=>s.trim()).filter(Boolean) : []; } catch(e) { tags = []; }
        const isUrgent = c.priority === 'urgent';
        const isHigh = c.priority === 'high';
        const hasMira = c.mira_unread;
        const cardStyle = isUrgent ? 'border-color:var(--danger);background:rgba(239,68,68,0.08);box-shadow:0 0 8px rgba(239,68,68,0.3);' 
                        : isHigh ? 'border-color:var(--warning);background:rgba(245,158,11,0.05);' 
                        : hasMira ? 'border-color:var(--accent);box-shadow:0 0 8px var(--accent-glow);' 
                        : '';
        return `<div class="k-card ${c.priority}" draggable="true" ondragstart="dragCard(event,${c.id})" data-id="${c.id}" onclick="openQuickPanel(${c.id}, ${hasMira ? 'true' : 'false'})" style="${cardStyle}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px;">
            <div class="k-card-title" style="flex:1;">${isUrgent ? 'üö® ' : isHigh ? 'üî• ' : ''}${esc(c.title)}</div>
            ${hasMira ? '<span style="background:var(--accent);color:white;font-size:0.5rem;padding:1px 5px;border-radius:6px;white-space:nowrap;">üîÆ</span>' : ''}
          </div>
          <div class="k-card-meta">${tags.map(t=>`<span class="k-tag ${t.toLowerCase().replace(/[^a-z]/g,'')}">${esc(t)}</span>`).join('')}</div>
          <div class="k-card-date">${fmtDate(c.created_at)}${c.notes ? ' ¬∑ üìù' : ''}</div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ
let draggedId = null;
function dragCard(e, id) { draggedId = id; e.dataTransfer.effectAllowed = 'move'; }
async function dropCard(e) {
  e.preventDefault();
  if(!draggedId) return;
  const newStatus = e.currentTarget.dataset.status;
  await api(`/api/tasks/${draggedId}`, { method:'PUT', body:JSON.stringify({status:newStatus}) });
  draggedId = null;
  loadDashboard();
}

// ‚îÄ‚îÄ Pipeline Page ‚îÄ‚îÄ
async function loadPipeline() {
  document.getElementById('page-title').textContent = 'CIO Pipeline';
  document.getElementById('page-sub').textContent = 'Track and manage hospital CIO relationships';
  const cios = await api('/api/cio');
  const statuses = ['prospect','researching','contacted','meeting','proposal','nurture','won'];
  document.getElementById('content').innerHTML = `
    <div style="margin-bottom:16px"><button class="btn primary" onclick="openNewCIO()">+ Add CIO Target</button></div>
    <div class="panel"><div class="panel-body" style="max-height:none">
      ${cios.map(c => `
        <div class="cio-item" style="padding:14px 0;cursor:pointer" onclick="editCIO(${c.id})">
          <div class="cio-info" style="flex:1">
            <h4 style="font-size:0.88rem">${esc(c.organization)}</h4>
            <p>${esc(c.name!=='TBD'?c.name+' ¬∑ ':'')}${esc(c.location)}${c.notes?' ¬∑ '+esc(c.notes.substring(0,60)):''}</p>
          </div>
          <span class="cio-status ${c.status}">${c.status}</span>
        </div>`).join('')}
    </div></div>`;
}

// ‚îÄ‚îÄ Sales Pipeline Page ‚îÄ‚îÄ
async function loadSalesPipeline() {
  document.getElementById('page-title').textContent = 'Sales Pipeline';
  document.getElementById('page-sub').textContent = 'Challenger-MEDDPICC deal management';
  
  const [deals, nudges, stats, cios] = await Promise.all([
    api('/api/pipeline'),
    api('/api/pipeline/nudges'),
    api('/api/pipeline/stats'),
    api('/api/cio')
  ]);
  
  const stages = ['outreach', 'teach', 'qualify', 'expand', 'propose', 'close', 'won'];
  const stageLabels = {
    outreach: 'Outreach',
    teach: 'Teach',
    qualify: 'Qualify', 
    expand: 'Expand',
    propose: 'Propose',
    close: 'Close',
    won: 'Won'
  };
  
  // Group deals by stage
  const dealsByStage = {};
  stages.forEach(stage => dealsByStage[stage] = []);
  deals.forEach(deal => {
    if (dealsByStage[deal.stage]) dealsByStage[deal.stage].push(deal);
  });
  
  // Calculate days in stage for urgency colors
  const now = new Date();
  deals.forEach(deal => {
    const stageDate = new Date(deal.stage_entered_at);
    deal.daysInStage = Math.floor((now - stageDate) / (1000 * 60 * 60 * 24));
  });
  
  document.getElementById('pipeline-badge').textContent = deals.filter(d => d.stage !== 'won' && d.stage !== 'lost').length;
  
  let html = `
    <div style="margin-bottom:16px;display:flex;gap:10px;align-items:center;">
      <button class="btn primary" onclick="openNewDeal()">+ New Deal</button>
      <div style="margin-left:auto;display:flex;gap:16px;">
        <span style="font-size:0.85rem;color:var(--text-dim);">Pipeline Value: <strong style="color:var(--success);">$${(stats.totalValue||0).toLocaleString()}</strong></span>
        <span style="font-size:0.85rem;color:var(--text-dim);">Active Deals: <strong style="color:var(--accent);">${deals.filter(d => d.stage !== 'won' && d.stage !== 'lost').length}</strong></span>
      </div>
    </div>`;
  
  // Nudge Queue
  if (nudges.length > 0) {
    html += `<div class="panel" style="margin-bottom:16px;border-left:3px solid var(--warning);">
      <div class="panel-header">
        <h3>‚ö†Ô∏è Nudge Queue <span style="background:var(--danger);color:white;font-size:0.6rem;padding:2px 6px;border-radius:8px;margin-left:6px;">${nudges.length}</span></h3>
      </div>
      <div class="panel-body" style="max-height:120px;">`;
    
    nudges.slice(0,5).forEach(nudge => {
      const priorityColor = nudge.priority === 'high' ? 'var(--danger)' : 'var(--warning)';
      html += `<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;">
        <span style="width:8px;height:8px;background:${priorityColor};border-radius:50%;"></span>
        <div style="flex:1;">
          <div style="font-size:0.8rem;font-weight:500;">${esc(nudge.message)}</div>
          <div style="font-size:0.7rem;color:var(--text-muted);">${esc(nudge.action_suggestion)}</div>
        </div>
      </div>`;
    });
    
    html += `</div></div>`;
  }
  
  // Kanban Board
  html += `<div style="display:grid;grid-template-columns:repeat(7,minmax(200px,1fr));gap:14px;margin-bottom:20px;overflow-x:auto;">`;
  
  stages.forEach(stage => {
    const deals = dealsByStage[stage];
    html += `<div class="kanban-col">
      <div class="kanban-header">
        <div class="kanban-title">${stageLabels[stage]} <span class="kanban-count">${deals.length}</span></div>
      </div>
      <div class="kanban-cards" style="min-height:300px;">`;
    
    deals.forEach(deal => {
      const urgencyClass = deal.daysInStage > 14 ? 'red' : deal.daysInStage > 7 ? 'yellow' : 'green';
      const urgencyStyle = urgencyClass === 'red' ? 'border-left:3px solid var(--danger)' : 
                          urgencyClass === 'yellow' ? 'border-left:3px solid var(--warning)' : 
                          'border-left:3px solid var(--success)';
      
      html += `<div class="k-card" style="${urgencyStyle};cursor:pointer;" onclick="editDeal(${deal.id})">
        <div style="font-size:0.82rem;font-weight:600;margin-bottom:4px;">${esc(deal.organization || 'Unknown Org')}</div>
        <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:6px;">
          $${(deal.deal_value||0).toLocaleString()} ‚Ä¢ ${esc(deal.engagement_type)}
        </div>
        ${deal.next_action ? `<div style="font-size:0.68rem;color:var(--text-dim);margin-bottom:4px;">Next: ${esc(deal.next_action)}</div>` : ''}
        <div style="font-size:0.65rem;color:var(--text-muted);">${deal.daysInStage} days in stage</div>
      </div>`;
    });
    
    html += `</div></div>`;
  });
  
  html += `</div>`;
  
  document.getElementById('content').innerHTML = html;
}

function openNewDeal() { 
  showDealModal();
}

// editDeal is defined later - calls showDealGuidance for prescriptive coaching

async function showDealModal(dealId = null) {
  const [cios, deal] = await Promise.all([
    api('/api/cio'),
    dealId ? api(`/api/pipeline/${dealId}`) : Promise.resolve(null)
  ]);
  
  const isEdit = !!dealId;
  const modalHtml = `
    <div class="modal-overlay" id="dealModal" style="display:flex;">
      <div class="modal" style="width:600px;">
        <div class="modal-head">
          ${isEdit ? 'Edit Deal' : 'New Deal'} 
          <button class="modal-close" onclick="closeModal('dealModal')">‚úï</button>
        </div>
        <div class="modal-body">
          <label>CIO Target</label>
          <select id="dealCioId">
            <option value="">Select Target...</option>
            ${cios.map(c => `<option value="${c.id}" ${deal?.cio_target_id === c.id ? 'selected' : ''}>${esc(c.organization)}</option>`).join('')}
          </select>
          
          <label>Stage</label>
          <select id="dealStage">
            <option value="outreach" ${deal?.stage === 'outreach' ? 'selected' : ''}>Outreach</option>
            <option value="teach" ${deal?.stage === 'teach' ? 'selected' : ''}>Teach</option>
            <option value="qualify" ${deal?.stage === 'qualify' ? 'selected' : ''}>Qualify</option>
            <option value="expand" ${deal?.stage === 'expand' ? 'selected' : ''}>Expand</option>
            <option value="propose" ${deal?.stage === 'propose' ? 'selected' : ''}>Propose</option>
            <option value="close" ${deal?.stage === 'close' ? 'selected' : ''}>Close</option>
            <option value="won" ${deal?.stage === 'won' ? 'selected' : ''}>Won</option>
            <option value="lost" ${deal?.stage === 'lost' ? 'selected' : ''}>Lost</option>
          </select>
          
          <label>Deal Value ($)</label>
          <input type="number" id="dealValue" placeholder="e.g. 50000" value="${deal?.deal_value || ''}">
          
          <label>Engagement Type</label>
          <select id="dealEngagement">
            <option value="advisor" ${deal?.engagement_type === 'advisor' ? 'selected' : ''}>AI Advisor</option>
            <option value="activator" ${deal?.engagement_type === 'activator' ? 'selected' : ''}>AI Activator</option>
            <option value="assessment" ${deal?.engagement_type === 'assessment' ? 'selected' : ''}>Assessment</option>
            <option value="sdk" ${deal?.engagement_type === 'sdk' ? 'selected' : ''}>SDK</option>
          </select>
          
          <label>Next Action</label>
          <input type="text" id="dealNextAction" placeholder="e.g. Follow up on proposal" value="${deal?.next_action || ''}">
          
          <label>Next Action Date</label>
          <input type="date" id="dealNextDate" value="${deal?.next_action_date || ''}">
          
          <div style="border-top:1px solid var(--border);margin:16px 0;padding-top:16px;">
            <h4 style="font-size:0.9rem;margin-bottom:12px;color:var(--accent);">MEDDPICC Fields</h4>
          </div>
          
          <label>Metrics</label>
          <input type="text" id="dealMetrics" placeholder="e.g. Reduce readmissions by 15%" value="${deal?.metrics || ''}">
          
          <label>Economic Buyer</label>
          <input type="text" id="dealEconomicBuyer" placeholder="e.g. CFO Sarah Johnson" value="${deal?.economic_buyer || ''}">
          
          <label>Decision Criteria</label>
          <textarea id="dealDecisionCriteria" placeholder="What factors drive their decision?">${deal?.decision_criteria || ''}</textarea>
          
          <label>Decision Process</label>
          <textarea id="dealDecisionProcess" placeholder="How do they make decisions?">${deal?.decision_process || ''}</textarea>
          
          <label>Paper Process</label>
          <input type="text" id="dealPaperProcess" placeholder="e.g. Legal review, 3 quotes required" value="${deal?.paper_process || ''}">
          
          <label>Identified Pain</label>
          <textarea id="dealPain" placeholder="What specific pain points are we solving?">${deal?.identified_pain || ''}</textarea>
          
          <label>Champion</label>
          <input type="text" id="dealChampion" placeholder="e.g. Dr. Mike Chen, CMO" value="${deal?.champion || ''}">
          
          <label>Competition</label>
          <input type="text" id="dealCompetition" placeholder="e.g. IBM Watson, Internal team" value="${deal?.competition || ''}">
          
          <label>Notes</label>
          <textarea id="dealNotes" placeholder="Additional context, objections, etc.">${deal?.notes || ''}</textarea>
        </div>
        <div class="modal-foot">
          <button class="btn" onclick="closeModal('dealModal')">Cancel</button>
          <button class="btn primary" onclick="saveDeal(${dealId || 'null'})">${isEdit ? 'Update' : 'Create'} Deal</button>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('dealModal');
  if (existing) existing.remove();
  
  // Add new modal
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function saveDeal(dealId) {
  const dealData = {
    cio_target_id: document.getElementById('dealCioId').value || null,
    stage: document.getElementById('dealStage').value,
    deal_value: parseInt(document.getElementById('dealValue').value) || 0,
    engagement_type: document.getElementById('dealEngagement').value,
    next_action: document.getElementById('dealNextAction').value,
    next_action_date: document.getElementById('dealNextDate').value || null,
    metrics: document.getElementById('dealMetrics').value,
    economic_buyer: document.getElementById('dealEconomicBuyer').value,
    decision_criteria: document.getElementById('dealDecisionCriteria').value,
    decision_process: document.getElementById('dealDecisionProcess').value,
    paper_process: document.getElementById('dealPaperProcess').value,
    identified_pain: document.getElementById('dealPain').value,
    champion: document.getElementById('dealChampion').value,
    competition: document.getElementById('dealCompetition').value,
    notes: document.getElementById('dealNotes').value
  };
  
  try {
    if (dealId) {
      await api(`/api/pipeline/${dealId}`, { method: 'PUT', body: JSON.stringify(dealData) });
    } else {
      await api('/api/pipeline', { method: 'POST', body: JSON.stringify(dealData) });
    }
    
    closeModal('dealModal');
    loadSalesPipeline();
  } catch (error) {
    alert('Error saving deal: ' + error.message);
  }
}

// ‚îÄ‚îÄ Sales Pipeline Page ‚îÄ‚îÄ
async function loadSalesPipeline() {
  document.getElementById('page-title').textContent = 'Sales Pipeline';
  document.getElementById('page-sub').textContent = 'Challenger-MEDDPICC Deal Tracker';

  const [deals, nudges, stats, cios] = await Promise.all([
    api('/api/pipeline'), api('/api/pipeline/nudges'), api('/api/pipeline/stats'), api('/api/cio')
  ]);

  document.getElementById('pipeline-badge').textContent = deals.length;

  const stages = ['outreach','teach','qualify','expand','propose','close','won'];
  const stageLabels = {outreach:'üì§ Outreach',teach:'üéì Teach',qualify:'üîç Qualify',expand:'ü§ù Expand',propose:'üìã Propose',close:'ü§û Close',won:'üèÜ Won'};
  const stageDeals = {};
  stages.forEach(s => stageDeals[s] = []);
  deals.forEach(d => { if(stageDeals[d.stage]) stageDeals[d.stage].push(d); });

  const criticalNudges = nudges.filter(n => n.priority === 'critical' || n.priority === 'high');

  document.getElementById('content').innerHTML = `
    ${criticalNudges.length ? `
    <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:16px;margin-bottom:20px">
      <h3 style="color:#ef4444;margin:0 0 8px">üö® Action Required (${criticalNudges.length})</h3>
      ${criticalNudges.map(n => `
        <div style="padding:8px 0;border-bottom:1px solid rgba(239,68,68,0.1);display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="background:${n.priority==='critical'?'#ef4444':'#f59e0b'};color:#fff;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:600;margin-right:8px">${n.priority.toUpperCase()}</span>
            <span style="color:var(--text-primary)">${esc(n.message)}</span>
          </div>
          <span style="color:var(--text-muted);font-size:0.75rem;white-space:nowrap;margin-left:12px">${esc(n.action_suggestion)}</span>
        </div>`).join('')}
    </div>` : ''}

    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Active Deals</div><div class="stat-value" style="color:var(--accent)">${deals.filter(d=>d.stage!=='won'&&d.stage!=='lost').length}</div></div>
      <div class="stat-card"><div class="stat-label">Pipeline Value</div><div class="stat-value" style="color:var(--success)">$${(stats.totalValue||0).toLocaleString()}</div></div>
      <div class="stat-card"><div class="stat-label">Won</div><div class="stat-value" style="color:var(--purple)">${stageDeals.won.length}</div></div>
      <div class="stat-card"><div class="stat-label">Nudges</div><div class="stat-value" style="color:${nudges.length>0?'#ef4444':'var(--text-muted)'}">${nudges.length}</div></div>
    </div>

    <div style="margin-bottom:16px;display:flex;gap:8px">
      <button class="btn primary" onclick="openNewDeal()">+ New Deal</button>
    </div>

    <div class="kanban" style="grid-template-columns:repeat(${stages.length}, minmax(180px, 1fr))">
      ${stages.map(s => {
        const sDeals = stageDeals[s];
        return `<div class="kanban-col">
          <div class="kanban-header"><div class="kanban-title">${stageLabels[s]} <span class="kanban-count">${sDeals.length}</span></div></div>
          <div class="kanban-cards" data-stage="${s}" ondrop="dropDeal(event)" ondragover="event.preventDefault()">
            ${sDeals.map(d => {
              const daysInStage = d.days_in_stage || Math.floor((Date.now() - new Date(d.stage_entered_at).getTime()) / 86400000);
              const urgencyColor = daysInStage > 14 ? '#ef4444' : daysInStage > 7 ? '#f59e0b' : '#10b981';
              const engLabel = {advisor:'Advisory',activator:'Activator',assessment:'Assessment',sdk:'SDK'}[d.engagement_type] || d.engagement_type;
              return `<div class="k-card" draggable="true" ondragstart="dragDeal(event,${d.id})" data-id="${d.id}" style="cursor:pointer;border-left:3px solid ${urgencyColor}" onclick="editDeal(${d.id})">
                <div class="k-card-title">${esc(d.organization || 'Unknown')}</div>
                <div style="font-size:0.72rem;color:var(--text-muted);margin:4px 0">${esc(d.name && d.name !== 'TBD' ? d.name : '')}</div>
                ${d.deal_value ? `<div style="font-size:0.82rem;color:var(--success);font-weight:600">$${d.deal_value.toLocaleString()}</div>` : ''}
                <div class="k-card-meta">
                  <span class="k-tag">${engLabel}</span>
                  <span class="k-tag" style="background:${urgencyColor}20;color:${urgencyColor}">${daysInStage}d</span>
                </div>
                ${d.next_action ? `<div style="font-size:0.7rem;color:var(--accent);margin-top:6px">‚Üí ${esc(d.next_action)}</div>` : ''}
              </div>`;
            }).join('')}
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

// Deal drag & drop
let draggedDealId = null;
function dragDeal(e, id) { draggedDealId = id; e.dataTransfer.effectAllowed = 'move'; }
async function dropDeal(e) {
  e.preventDefault();
  if(!draggedDealId) return;
  const newStage = e.currentTarget.dataset.stage;
  await api(`/api/pipeline/${draggedDealId}`, { method:'PUT', body:JSON.stringify({stage:newStage}) });
  draggedDealId = null;
  loadSalesPipeline();
}

// New Deal Modal
function openNewDeal() {
  const cios = window._cachedCios || [];
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'dealModal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:500px">
      <h3 style="margin:0 0 16px">New Deal</h3>
      <label style="display:block;margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">CIO Target</label>
      <select id="dealCio" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);margin-bottom:12px">
        <option value="">‚Äî Select ‚Äî</option>
      </select>
      <label style="display:block;margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">Stage</label>
      <select id="dealStage" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);margin-bottom:12px">
        <option value="outreach">Outreach</option><option value="teach">Teach</option><option value="qualify">Qualify</option>
        <option value="expand">Expand</option><option value="propose">Propose</option><option value="close">Close</option>
      </select>
      <label style="display:block;margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">Engagement Type</label>
      <select id="dealType" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);margin-bottom:12px">
        <option value="advisor">AI Advisor ($8-15K/mo)</option><option value="activator">AI Activator ($15-40K)</option>
        <option value="assessment">LUMEN Assessment ($3-7K)</option><option value="sdk">SDK License</option>
      </select>
      <label style="display:block;margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">Deal Value ($)</label>
      <input id="dealValue" type="number" placeholder="0" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);margin-bottom:12px">
      <label style="display:block;margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">Next Action</label>
      <input id="dealAction" type="text" placeholder="e.g. Send follow-up email" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);margin-bottom:12px">
      <label style="display:block;margin-bottom:8px;font-size:0.8rem;color:var(--text-muted)">Next Action Date</label>
      <input id="dealActionDate" type="date" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);margin-bottom:16px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="this.closest('.modal').remove()">Cancel</button>
        <button class="btn primary" onclick="saveDeal()">Create Deal</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  // Populate CIO dropdown
  api('/api/cio').then(cios => {
    const sel = document.getElementById('dealCio');
    cios.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = `${c.organization} (${c.name})`; sel.appendChild(o); });
  });
}

async function saveDeal() {
  const cio = document.getElementById('dealCio').value;
  await api('/api/pipeline', { method:'POST', body:JSON.stringify({
    cio_target_id: cio || null,
    stage: document.getElementById('dealStage').value,
    engagement_type: document.getElementById('dealType').value,
    deal_value: parseInt(document.getElementById('dealValue').value) || 0,
    next_action: document.getElementById('dealAction').value,
    next_action_date: document.getElementById('dealActionDate').value || null
  })});
  document.getElementById('dealModal').remove();
  loadSalesPipeline();
}

// editDeal function is defined in the deal guidance script section below

async function updateDeal(id) {
  const body = {
    stage: document.getElementById('ed_stage').value,
    deal_value: parseInt(document.getElementById('ed_value').value) || 0,
    next_action: document.getElementById('ed_action').value,
    next_action_date: document.getElementById('ed_action_date').value || null,
    metrics: document.getElementById('ed_metrics').value,
    economic_buyer: document.getElementById('ed_economic_buyer').value,
    decision_criteria: document.getElementById('ed_decision_criteria').value,
    decision_process: document.getElementById('ed_decision_process').value,
    paper_process: document.getElementById('ed_paper_process').value,
    identified_pain: document.getElementById('ed_identified_pain').value,
    champion: document.getElementById('ed_champion').value,
    competition: document.getElementById('ed_competition').value,
  };
  await api(`/api/pipeline/${id}`, { method:'PUT', body:JSON.stringify(body) });
  document.getElementById('editDealModal').remove();
  loadSalesPipeline();
}

async function deleteDeal(id) {
  if(!confirm('Delete this deal?')) return;
  await api(`/api/pipeline/${id}`, { method:'DELETE' });
  document.getElementById('editDealModal').remove();
  loadSalesPipeline();
}

// ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
function openNewTask() { document.getElementById('taskModal').classList.add('show'); document.getElementById('taskTitle').focus(); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

async function saveTask() {
  const title = document.getElementById('taskTitle').value.trim();
  if(!title) return;
  const tags = document.getElementById('taskTags').value.split(',').map(t=>t.trim()).filter(Boolean);
  await api('/api/tasks', { method:'POST', body:JSON.stringify({
    title, description:document.getElementById('taskDesc').value,
    status:document.getElementById('taskStatus').value,
    priority:document.getElementById('taskPriority').value, tags
  })});
  closeModal('taskModal');
  document.getElementById('taskTitle').value='';
  document.getElementById('taskDesc').value='';
  document.getElementById('taskTags').value='';
  loadDashboard();
}

// ‚îÄ‚îÄ Chat (embedded in sidebar ‚Äî no toggle needed) ‚îÄ‚îÄ

// ‚îÄ‚îÄ Briefing Page ‚îÄ‚îÄ
let briefingDates = [];
let briefingIdx = 0;

async function loadBriefing() {
  document.getElementById('page-title').textContent = 'Daily Briefing';
  document.getElementById('page-sub').textContent = 'AI-curated intelligence for healthcare strategy';
  briefingDates = await api('/api/briefing/dates');
  if(!briefingDates.length) {
    document.getElementById('content').innerHTML = '<p style="color:var(--text-muted);padding:40px;text-align:center;">No briefings yet. Check back tomorrow morning.</p>';
    return;
  }
  briefingIdx = 0;
  renderBriefingDay();
}

async function renderBriefingDay() {
  const dateStr = briefingDates[briefingIdx];
  const data = await api('/api/briefing/' + dateStr);
  const fd = new Date(dateStr+'T12:00:00');
  const dayName = fd.toLocaleDateString('en-US',{weekday:'long'});
  const fullDate = fd.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});

  let html = `<div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
    <button class="btn" onclick="navBriefing(1)" ${briefingIdx>=briefingDates.length-1?'disabled style="opacity:0.3"':''}>‚Üê Older</button>
    <div style="flex:1;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:1.3rem;font-weight:700;">${fullDate}</div>
      <div style="font-size:0.78rem;color:var(--text-muted);">${dayName} ¬∑ Briefing #${briefingDates.length - briefingIdx}</div>
    </div>
    <button class="btn" onclick="navBriefing(-1)" ${briefingIdx<=0?'disabled style="opacity:0.3"':''}>Newer ‚Üí</button>
  </div>`;

  // Quote
  if(data.quote) {
    html += `<div class="panel" style="margin-bottom:14px;border-left:3px solid var(--success);">
      <div class="panel-body">
        <div style="font-family:'Space Grotesk',sans-serif;font-size:1.1rem;font-style:italic;line-height:1.5;">"${esc(data.quote.text)}"</div>
        <div style="color:var(--success);margin-top:8px;font-size:0.82rem;">‚Äî ${esc(data.quote.author)}</div>
        ${data.quote.reflection?`<div style="color:var(--text-dim);font-size:0.82rem;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">${esc(data.quote.reflection)}</div>`:''}
      </div>
    </div>`;
  }

  // Idea of the Day
  if(data.idea) {
    const i = data.idea;
    const vc = i.verdict==='build'?'success':i.verdict==='watch'?'warning':'danger';
    html += `<div class="panel" style="margin-bottom:14px;border-left:3px solid var(--warning);">
      <div class="panel-header"><h3>üí° Idea of the Day</h3></div>
      <div class="panel-body">
        <div style="font-size:1rem;font-weight:600;margin-bottom:4px;">${esc(i.title)}</div>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:10px;">${esc(i.source)}</div>
        <div style="font-size:0.85rem;color:var(--text-dim);line-height:1.6;">${esc(i.summary)}</div>
        ${i.scores?`<div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">${Object.entries(i.scores).map(([k,v])=>`<span style="background:var(--bg-surface);padding:4px 10px;border-radius:8px;font-size:0.72rem;"><span style="color:var(--warning);font-weight:600;">${v}</span><span style="color:var(--text-muted);">/10 ${k}</span></span>`).join('')}</div>`:''}
        ${i.revenueEstimate?`<div style="display:inline-flex;align-items:center;gap:4px;background:var(--success-bg);border:1px solid rgba(16,185,129,0.2);padding:4px 10px;border-radius:8px;font-size:0.75rem;font-weight:600;color:var(--success);margin-top:8px;">üí∞ ${esc(i.revenueEstimate)}</div>`:''}
        <div style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:8px;font-size:0.78rem;font-weight:600;margin-top:8px;background:var(--${vc}-bg);color:var(--${vc});">${esc(i.verdictNote||i.verdict)}</div>
        ${i.healthcareAngle?`<div style="background:var(--accent-glow);border:1px solid rgba(59,130,246,0.15);border-radius:var(--radius-sm);padding:12px;margin-top:12px;"><div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:600;margin-bottom:4px;">‚öïÔ∏è Healthcare Angle</div><p style="font-size:0.82rem;color:var(--text-dim);line-height:1.5;">${esc(i.healthcareAngle)}</p></div>`:''}
      </div>
    </div>`;
  }

  // Articles
  if(data.articles && data.articles.length) {
    html += `<div class="panel" style="margin-bottom:14px;">
      <div class="panel-header"><h3>üì∞ Articles</h3></div>
      <div class="panel-body" style="max-height:none;">`;
    data.articles.forEach(a => {
      html += `<div style="padding:12px 0;border-bottom:1px solid var(--border);">
        <a href="${esc(a.url)}" target="_blank" style="font-size:0.92rem;font-weight:600;color:var(--text);text-decoration:none;">${esc(a.title)}</a>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:3px;">${esc(a.source)} ¬∑ ${esc(a.date)}</div>
        <div style="font-size:0.82rem;color:var(--text-dim);line-height:1.5;margin-top:8px;">${esc(a.takeaway)}</div>
        ${a.linkedinAngle?`<div style="background:var(--purple-bg);border:1px solid rgba(139,92,246,0.15);border-radius:var(--radius-sm);padding:10px;margin-top:10px;"><div style="font-size:0.7rem;color:var(--purple);font-weight:600;margin-bottom:4px;">üíº LinkedIn Angle</div><div style="font-size:0.78rem;color:var(--text-dim);">${esc(a.linkedinAngle)}</div></div>`:''}
      </div>`;
    });
    html += `</div></div>`;
  }

  // Events
  if(data.events && data.events.length) {
    html += `<div class="panel" style="margin-bottom:14px;">
      <div class="panel-header"><h3>üìÖ Events & Webinars</h3></div>
      <div class="panel-body" style="max-height:none;">`;
    data.events.forEach(e => {
      html += `<div style="padding:10px 0;border-bottom:1px solid var(--border);">
        <div style="font-weight:600;font-size:0.88rem;">${esc(e.name)}</div>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:3px;">üìç ${esc(e.location||'Virtual')} ¬∑ üóìÔ∏è ${esc(e.date)}</div>
        ${e.description?`<div style="font-size:0.82rem;color:var(--text-dim);margin-top:6px;">${esc(e.description)}</div>`:''}
        ${e.url?`<a href="${esc(e.url)}" target="_blank" class="btn" style="display:inline-block;margin-top:8px;font-size:0.72rem;text-decoration:none;">üéüÔ∏è Register</a>`:''}
      </div>`;
    });
    html += `</div></div>`;
  }

  // Videos
  if(data.videos && data.videos.length) {
    html += `<div class="panel" style="margin-bottom:14px;">
      <div class="panel-header"><h3>üé¨ Watch</h3></div>
      <div class="panel-body" style="max-height:none;">`;
    data.videos.forEach(v => {
      html += `<div style="padding:10px 0;border-bottom:1px solid var(--border);">
        <a href="${esc(v.url)}" target="_blank" style="font-weight:600;font-size:0.88rem;color:var(--text);text-decoration:none;">${esc(v.title)}</a>
        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:3px;">${esc(v.source||'')} ¬∑ ${esc(v.duration||'')}</div>
        ${v.description?`<div style="font-size:0.82rem;color:var(--text-dim);margin-top:6px;">${esc(v.description)}</div>`:''}
      </div>`;
    });
    html += `</div></div>`;
  }

  // LinkedIn
  if(data.linkedin && data.linkedin.length) {
    html += `<div class="panel" style="margin-bottom:14px;">
      <div class="panel-header"><h3>üíº LinkedIn Pulse</h3></div>
      <div class="panel-body" style="max-height:none;">`;
    data.linkedin.forEach(l => {
      html += `<div style="padding:10px 0;border-bottom:1px solid var(--border);">
        <div style="font-weight:600;font-size:0.88rem;">${esc(l.author)}</div>
        <div style="font-size:0.72rem;color:var(--text-muted);">${esc(l.authorTitle||'')}</div>
        <div style="font-size:0.82rem;color:var(--text-dim);margin-top:6px;line-height:1.5;">${esc(l.insight)}</div>
        ${l.url?`<a href="${esc(l.url)}" target="_blank" class="btn" style="display:inline-block;margin-top:8px;font-size:0.72rem;text-decoration:none;">üîó View Post</a>`:''}
      </div>`;
    });
    html += `</div></div>`;
  }

  document.getElementById('content').innerHTML = html;
}

function navBriefing(dir) {
  briefingIdx += dir;
  if(briefingIdx < 0) briefingIdx = 0;
  if(briefingIdx >= briefingDates.length) briefingIdx = briefingDates.length - 1;
  renderBriefingDay();
  document.querySelector('.content').scrollTop = 0;
}

// ‚îÄ‚îÄ Leads Page ‚îÄ‚îÄ
async function loadLeads() {
  document.getElementById('page-title').textContent = 'Leads';
  document.getElementById('page-sub').textContent = 'Strategic opportunities by region ‚Äî Ontario ‚Üí Canada ‚Üí US ‚Üí UK ‚Üí Global';
  const leads = await api('/api/leads');
  document.getElementById('leads-badge').textContent = leads.length;

  const regionFlags = { ontario: 'üçÅ', canada: 'üá®üá¶', us: 'üá∫üá∏', uk: 'üá¨üáß', other: 'üåç' };
  const regionLabels = { ontario: 'Ontario', canada: 'Canada (Other)', us: 'United States', uk: 'United Kingdom', other: 'Global' };
  const statusColors = { new: 'var(--accent)', contacted: 'var(--warning)', meeting: 'var(--success)', nurture: 'var(--purple)', closed: 'var(--text-muted)' };

  // Group by region
  const byRegion = { ontario: [], canada: [], us: [], uk: [], other: [] };
  leads.forEach(l => {
    const r = l.region || 'other';
    if (byRegion[r]) byRegion[r].push(l);
    else byRegion.other.push(l);
  });

  let html = `<div style="margin-bottom:16px;display:flex;gap:10px;justify-content:space-between;align-items:center;">
    <button class="btn primary" onclick="openNewLead()">+ Add Lead</button>
    <div style="font-size:0.75rem;color:var(--text-muted);">${leads.length} leads ¬∑ ${leads.filter(l=>l.mira_unread).length} with Mira updates</div>
  </div>`;

  if(!leads.length) {
    html += '<p style="color:var(--text-muted);padding:40px;text-align:center;">No leads yet. I will find strategic opportunities for you.</p>';
  } else {
    for (const region of ['ontario', 'canada', 'us', 'uk', 'other']) {
      const regionLeads = byRegion[region];
      if (!regionLeads.length) continue;
      
      html += `<div style="margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <span style="font-size:1.3rem;">${regionFlags[region]}</span>
          <h3 style="font-size:0.9rem;font-weight:600;">${regionLabels[region]}</h3>
          <span style="font-size:0.68rem;color:var(--text-muted);background:var(--bg-card);padding:2px 8px;border-radius:10px;">${regionLeads.length}</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:12px;">`;
      
      regionLeads.forEach(l => {
        const hasMira = l.mira_unread || (l.mira_notes && l.mira_notes.length > 0);
        const statusColor = statusColors[l.status] || 'var(--text-muted)';
        html += `
          <div class="lead-card" onclick="openLeadPanel(${l.id})" style="background:var(--bg-card);border:1px solid ${l.mira_unread ? 'var(--accent)' : 'var(--border)'};border-radius:var(--radius);padding:14px;cursor:pointer;transition:all 0.15s;${l.mira_unread ? 'box-shadow:0 0 10px var(--accent-glow);' : ''}" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='${l.mira_unread ? 'var(--accent)' : 'var(--border)'}'" >
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
              <div>
                <div style="font-weight:600;font-size:0.88rem;display:flex;align-items:center;gap:6px;">
                  ${esc(l.name)}
                  ${l.mira_unread ? '<span style="background:var(--accent);color:white;font-size:0.55rem;padding:2px 6px;border-radius:8px;">üîÆ</span>' : ''}
                </div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${l.title ? esc(l.title) : ''}</div>
              </div>
              <span style="font-size:0.65rem;padding:3px 8px;border-radius:6px;background:${statusColor}20;color:${statusColor};font-weight:500;">${l.status || 'new'}</span>
            </div>
            <div style="font-size:0.8rem;color:var(--text);margin-bottom:6px;">${esc(l.organization)}</div>
            ${l.interest ? `<div style="font-size:0.68rem;color:var(--accent);margin-bottom:6px;">${esc(l.interest)}</div>` : ''}
            ${l.next_action ? `<div style="font-size:0.68rem;color:var(--warning);margin-top:6px;">‚ö° ${esc(l.next_action.substring(0,50))}${l.next_action.length > 50 ? '...' : ''}</div>` : ''}
            ${l.proposed_outreach ? `<div style="font-size:0.68rem;color:var(--text-muted);margin-top:6px;font-style:italic;">"${esc(l.proposed_outreach.substring(0,60))}..."</div>` : ''}
          </div>`;
      });
      html += '</div></div>';
    }
  }

  document.getElementById('content').innerHTML = html;
}

// Lead slide-out panel
let currentLeadId = null;
async function openLeadPanel(leadId) {
  currentLeadId = leadId;
  const lead = await api('/api/leads/' + leadId);
  if (!lead) return;
  
  const regionFlags = { ontario: 'üçÅ', canada: 'üá®üá¶', us: 'üá∫üá∏', uk: 'üá¨üáß', other: 'üåç' };
  
  const panel = document.getElementById('leadPanel');
  const overlay = document.getElementById('leadPanelOverlay');
  
  document.getElementById('lpName').value = lead.name || '';
  document.getElementById('lpTitle').value = lead.title || '';
  document.getElementById('lpOrg').value = lead.organization || '';
  document.getElementById('lpEmail').value = lead.email || '';
  document.getElementById('lpLinkedin').value = lead.linkedin || '';
  document.getElementById('lpRegion').value = lead.region || 'other';
  document.getElementById('lpStatus').value = lead.status || 'new';
  document.getElementById('lpInterest').value = lead.interest || '';
  document.getElementById('lpNextAction').value = lead.next_action || '';
  document.getElementById('lpOutreach').value = lead.proposed_outreach || '';
  document.getElementById('lpNotes').value = lead.notes || '';
  document.getElementById('lpMiraNotes').innerHTML = lead.mira_notes ? `<div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:0.78rem;line-height:1.5;white-space:pre-wrap;">${esc(lead.mira_notes)}</div>` : '<span style="color:var(--text-muted);font-size:0.78rem;">No Mira research notes yet.</span>';
  
  // Show Mira banner if unread
  const miraBanner = document.getElementById('lpMiraBanner');
  if (lead.mira_unread) {
    miraBanner.style.display = 'block';
    miraBanner.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:1rem;">üîÆ</span>
          <span style="font-size:0.78rem;font-weight:600;color:var(--accent);">Mira added research</span>
        </div>
        <button onclick="markLeadRead(${leadId})" style="background:transparent;border:1px solid var(--accent);color:var(--accent);padding:3px 8px;border-radius:4px;font-size:0.65rem;cursor:pointer;">‚òë Read</button>
      </div>
    `;
  } else {
    miraBanner.style.display = 'none';
  }
  
  panel.classList.add('open');
  overlay.classList.add('open');
}

function closeLeadPanel() {
  document.getElementById('leadPanel').classList.remove('open');
  document.getElementById('leadPanelOverlay').classList.remove('open');
  currentLeadId = null;
}

async function saveLeadPanel() {
  if (!currentLeadId) return;
  const data = {
    name: document.getElementById('lpName').value,
    title: document.getElementById('lpTitle').value,
    organization: document.getElementById('lpOrg').value,
    email: document.getElementById('lpEmail').value,
    linkedin: document.getElementById('lpLinkedin').value,
    region: document.getElementById('lpRegion').value,
    status: document.getElementById('lpStatus').value,
    interest: document.getElementById('lpInterest').value,
    next_action: document.getElementById('lpNextAction').value,
    proposed_outreach: document.getElementById('lpOutreach').value,
    notes: document.getElementById('lpNotes').value
  };
  await api('/api/leads/' + currentLeadId, { method: 'PUT', body: JSON.stringify(data) });
  closeLeadPanel();
  loadLeads();
}

async function deleteLeadPanel() {
  if (!currentLeadId || !confirm('Delete this lead?')) return;
  await api('/api/leads/' + currentLeadId, { method: 'DELETE' });
  closeLeadPanel();
  loadLeads();
}

async function markLeadRead(leadId) {
  await api('/api/leads/' + leadId + '/mark-read', { method: 'POST' });
  const banner = document.getElementById('lpMiraBanner');
  if (banner) { banner.style.display = 'none'; }
  loadLeads();
}

function openNewLead() { document.getElementById('leadModal').classList.add('show'); document.getElementById('leadName').focus(); }

async function saveLead() {
  const name = document.getElementById('leadName').value.trim();
  const org = document.getElementById('leadOrg').value.trim();
  if(!name || !org) return;
  await api('/api/leads', { method:'POST', body:JSON.stringify({
    name, title:document.getElementById('leadTitle').value,
    organization:org, email:document.getElementById('leadEmail').value,
    phone:document.getElementById('leadPhone').value,
    interest:document.getElementById('leadInterest').value,
    source:document.getElementById('leadSource').value,
    notes:document.getElementById('leadNotes').value
  })});
  closeModal('leadModal');
  ['leadName','leadTitle','leadOrg','leadEmail','leadPhone','leadSource','leadNotes'].forEach(id=>document.getElementById(id).value='');
  loadLeads();
}

async function deleteLead(id) {
  if(!confirm('Delete this lead?')) return;
  await api('/api/leads/'+id, {method:'DELETE'});
  loadLeads();
}

// ‚îÄ‚îÄ Notes ‚îÄ‚îÄ
async function loadNotes() {
  document.getElementById('page-title').textContent = 'Notes';
  document.getElementById('page-sub').textContent = 'Reusable templates, research & strategic notes';
  
  let notes = [], actions = [];
  try {
    [notes, actions] = await Promise.all([api('/api/notes'), api('/api/actions')]);
  } catch(e) {
    document.getElementById('content').innerHTML = `<div style="padding:40px;color:var(--danger);">Error loading notes: ${e.message}</div>`;
    return;
  }

  const categories = [...new Set(notes.map(n => n.category || 'general'))].sort();
  const pinnedNotes = notes.filter(n => n.pinned);
  const unpinnedNotes = notes.filter(n => !n.pinned);
  const pendingActions = actions.filter(a => a.status !== 'done');
  const completedActions = actions.filter(a => a.status === 'done').slice(0, 5);

  document.getElementById('content').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 320px;gap:20px;height:100%;">
      <!-- Left: Notes -->
      <div style="overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn primary" onclick="openNoteModal()">+ New Note</button>
            <select id="noteCategoryFilter" onchange="filterNotes()" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text);padding:7px 14px;border-radius:var(--radius-sm);font-size:0.78rem;">
              <option value="">All Categories</option>
              ${categories.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('')}
            </select>
          </div>
        </div>
        
        ${pinnedNotes.length ? `
          <div style="margin-bottom:24px;">
            <h3 style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;">üìå Pinned</h3>
            <div class="notes-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;">
              ${pinnedNotes.map(n => renderNoteCard(n)).join('')}
            </div>
          </div>
        ` : ''}
        
        <div>
          <h3 style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;">All Notes</h3>
          <div class="notes-grid" id="notesContainer" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;">
            ${unpinnedNotes.length ? unpinnedNotes.map(n => renderNoteCard(n)).join('') : '<p style="color:var(--text-muted);grid-column:1/-1;">No notes yet. Create your first note to get started.</p>'}
          </div>
        </div>
      </div>
      
      <!-- Right: Actions Panel -->
      <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;max-height:calc(100vh - 180px);">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
          <h3 style="font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:8px;">
            üéØ Actions
            ${pendingActions.length ? `<span style="background:var(--accent);color:white;font-size:0.6rem;padding:2px 7px;border-radius:10px;">${pendingActions.length}</span>` : ''}
          </h3>
          <button class="btn" style="padding:4px 10px;font-size:0.72rem;" onclick="openActionModal()">+ Add</button>
        </div>
        <div style="flex:1;overflow-y:auto;padding:10px;">
          ${pendingActions.length ? pendingActions.map(a => renderActionItem(a)).join('') : '<p style="color:var(--text-muted);font-size:0.78rem;padding:10px;text-align:center;">No pending actions.<br><span style="font-size:0.7rem;">Use @Mira: in notes to create directives</span></p>'}
          
          ${completedActions.length ? `
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
              <h4 style="font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">Recently Completed</h4>
              ${completedActions.map(a => renderActionItem(a, true)).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

// ‚îÄ‚îÄ Archived Page ‚îÄ‚îÄ
async function loadArchived() {
  document.getElementById('page-title').textContent = 'Archived';
  document.getElementById('page-sub').textContent = 'Completed tasks organized by category';
  
  let tasks = [];
  try {
    tasks = await api('/api/tasks');
  } catch(e) {
    document.getElementById('content').innerHTML = `<div style="padding:40px;color:var(--danger);">Error loading tasks: ${e.message}</div>`;
    return;
  }
  
  const archivedTasks = tasks.filter(t => t.status === 'done').sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
  
  // Organize by primary tag (first tag) or "Uncategorized"
  const categories = {};
  archivedTasks.forEach(t => {
    let tags = [];
    try { tags = JSON.parse(t.tags || '[]'); } catch(e) {}
    const category = tags[0] || 'Uncategorized';
    if (!categories[category]) categories[category] = [];
    categories[category].push(t);
  });
  
  const sortedCategories = Object.keys(categories).sort((a, b) => {
    if (a === 'Uncategorized') return 1;
    if (b === 'Uncategorized') return -1;
    return a.localeCompare(b);
  });
  
  document.getElementById('content').innerHTML = `
    <div style="margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
      <div style="display:flex;gap:10px;align-items:center;">
        <input type="text" id="archiveSearch" placeholder="Search archived tasks..." oninput="filterArchived()" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:var(--radius-sm);font-size:0.82rem;width:250px;">
        <select id="archiveCategoryFilter" onchange="filterArchived()" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:var(--radius-sm);font-size:0.82rem;">
          <option value="">All Categories</option>
          ${sortedCategories.map(c => `<option value="${esc(c)}">${esc(c)} (${categories[c].length})</option>`).join('')}
        </select>
      </div>
      <div style="font-size:0.78rem;color:var(--text-muted);">${archivedTasks.length} completed tasks</div>
    </div>
    
    <div id="archivedContainer">
      ${sortedCategories.map(cat => `
        <div class="archive-category" data-category="${esc(cat)}" style="margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;cursor:pointer;" onclick="toggleArchiveCategory(this)">
            <span class="cat-arrow" style="color:var(--text-muted);transition:transform 0.2s;">‚ñº</span>
            <h3 style="font-size:0.85rem;font-weight:600;color:var(--text);">${esc(cat)}</h3>
            <span style="font-size:0.68rem;color:var(--text-muted);background:var(--bg-card);padding:2px 8px;border-radius:10px;">${categories[cat].length}</span>
          </div>
          <div class="cat-items" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:10px;">
            ${categories[cat].map(t => renderArchivedTaskCard(t)).join('')}
          </div>
        </div>
      `).join('')}
      ${!archivedTasks.length ? '<p style="color:var(--text-muted);text-align:center;padding:40px;">No completed tasks yet. Tasks marked as Done will appear here.</p>' : ''}
    </div>
  `;
}

function renderArchivedTaskCard(t) {
  let tags = []; try { tags = JSON.parse(t.tags || '[]'); } catch(e) {}
  return `
    <div class="archive-task" data-title="${esc(t.title.toLowerCase())}" data-tags="${esc(tags.join(' ').toLowerCase())}" style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
        <div style="flex:1;min-width:0;">
          <div style="font-size:0.82rem;font-weight:500;color:var(--text);line-height:1.3;margin-bottom:6px;">‚úÖ ${esc(t.title)}</div>
          ${tags.length > 1 ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px;">${tags.slice(1).map(tag => `<span style="font-size:0.6rem;background:var(--bg-surface);color:var(--text-muted);padding:2px 6px;border-radius:3px;">${esc(tag)}</span>`).join('')}</div>` : ''}
          <div style="font-size:0.65rem;color:var(--text-muted);">Completed ${fmtDate(t.updated_at)}</div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0;">
          <button onclick="reopenTask(${t.id})" title="Reopen" style="background:var(--bg-surface);border:1px solid var(--border);color:var(--text-dim);width:28px;height:28px;border-radius:4px;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">‚Ü©</button>
          <button onclick="deleteTaskPermanently(${t.id})" title="Delete permanently" style="background:var(--bg-surface);border:1px solid var(--border);color:var(--text-dim);width:28px;height:28px;border-radius:4px;cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='var(--danger)';this.style.color='var(--danger)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">üóë</button>
        </div>
      </div>
      ${t.notes ? `<div style="font-size:0.72rem;color:var(--text-dim);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);line-height:1.4;max-height:50px;overflow:hidden;">${esc(t.notes.substring(0, 120))}${t.notes.length > 120 ? '...' : ''}</div>` : ''}
    </div>
  `;
}

function toggleArchiveCategory(el) {
  const arrow = el.querySelector('.cat-arrow');
  const items = el.nextElementSibling;
  if (items.style.display === 'none') {
    items.style.display = 'grid';
    arrow.style.transform = 'rotate(0deg)';
  } else {
    items.style.display = 'none';
    arrow.style.transform = 'rotate(-90deg)';
  }
}

function filterArchived() {
  const search = document.getElementById('archiveSearch').value.toLowerCase();
  const category = document.getElementById('archiveCategoryFilter').value;
  
  document.querySelectorAll('.archive-category').forEach(cat => {
    const catName = cat.dataset.category;
    const matchesCategory = !category || catName === category;
    
    if (!matchesCategory) {
      cat.style.display = 'none';
      return;
    }
    
    cat.style.display = 'block';
    let visibleCount = 0;
    
    cat.querySelectorAll('.archive-task').forEach(task => {
      const title = task.dataset.title;
      const tags = task.dataset.tags;
      const matchesSearch = !search || title.includes(search) || tags.includes(search);
      task.style.display = matchesSearch ? 'block' : 'none';
      if (matchesSearch) visibleCount++;
    });
    
    // Hide category if no visible tasks
    if (visibleCount === 0 && search) {
      cat.style.display = 'none';
    }
  });
}

async function deleteTaskPermanently(taskId) {
  if (!confirm('Permanently delete this task? This cannot be undone.')) return;
  await api('/api/tasks/' + taskId, { method: 'DELETE' });
  loadArchived();
}

function renderArchivedTask(t) {
  let tags = []; try { tags = JSON.parse(t.tags || '[]'); } catch(e) {}
  return `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:8px;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;">
        <div style="flex:1;min-width:0;">
          <div style="font-size:0.78rem;font-weight:500;line-height:1.3;color:var(--text-dim);">‚úÖ ${esc(t.title)}</div>
          ${tags.length ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">${tags.slice(0,3).map(tag => `<span style="font-size:0.55rem;background:var(--bg-surface);color:var(--text-muted);padding:1px 5px;border-radius:3px;">${esc(tag)}</span>`).join('')}</div>` : ''}
          <div style="font-size:0.6rem;color:var(--text-muted);margin-top:4px;">Completed ${fmtDate(t.updated_at)}</div>
        </div>
        <button onclick="reopenTask(${t.id})" style="background:var(--bg-surface);border:1px solid var(--border);color:var(--text-dim);padding:4px 8px;border-radius:4px;font-size:0.65rem;cursor:pointer;white-space:nowrap;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">‚Ü© Reopen</button>
      </div>
      ${t.notes ? `<div style="font-size:0.68rem;color:var(--text-muted);margin-top:6px;padding-top:6px;border-top:1px solid var(--border);line-height:1.3;max-height:40px;overflow:hidden;">${esc(t.notes.substring(0, 100))}${t.notes.length > 100 ? '...' : ''}</div>` : ''}
    </div>
  `;
}

async function reopenTask(taskId) {
  await api('/api/tasks/' + taskId, { method: 'PUT', body: JSON.stringify({ status: 'todo' }) });
  // Refresh whichever page we're on
  const activePage = document.querySelector('.nav-item.active');
  if (activePage && activePage.textContent.includes('Archived')) {
    loadArchived();
  } else if (activePage && activePage.textContent.includes('Notes')) {
    loadNotes();
  }
  // Always refresh dashboard in background for kanban
  if (typeof loadDashboard === 'function') loadDashboard();
}

function renderActionItem(a, completed = false) {
  const priorityColor = a.priority === 'urgent' ? 'var(--danger)' : a.priority === 'high' ? 'var(--warning)' : 'var(--text-muted)';
  const statusIcon = a.status === 'done' ? '‚úÖ' : a.status === 'in_progress' ? '‚ö°' : '‚óã';
  return `
    <div class="action-item" style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:all 0.15s;${completed ? 'opacity:0.6;' : ''}" onclick="openActionModal(${a.id})" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:flex-start;gap:8px;">
        <span style="font-size:0.8rem;">${statusIcon}</span>
        <div style="flex:1;min-width:0;">
          <div style="font-size:0.78rem;font-weight:500;line-height:1.3;${completed ? 'text-decoration:line-through;' : ''}">${esc(a.description)}</div>
          ${a.mira_response ? `<div style="font-size:0.7rem;color:var(--accent);margin-top:4px;line-height:1.3;">‚Üí ${esc(a.mira_response.substring(0, 80))}${a.mira_response.length > 80 ? '...' : ''}</div>` : ''}
          <div style="font-size:0.6rem;color:var(--text-muted);margin-top:4px;">${fmtDate(a.created_at)}${a.priority !== 'normal' ? ` ¬∑ <span style="color:${priorityColor}">${a.priority}</span>` : ''}</div>
        </div>
      </div>
    </div>
  `;
}

let currentActionId = null;
async function openActionModal(id = null) {
  currentActionId = id;
  let action = { description: '', status: 'pending', priority: 'normal', mira_response: '' };
  
  if (id) {
    try {
      const actions = await api('/api/actions');
      action = actions.find(a => a.id === id) || action;
    } catch(e) {}
  }
  
  const modal = document.createElement('div');
  modal.id = 'actionModalOverlay';
  modal.className = 'modal-overlay show';
  modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
  modal.innerHTML = `
    <div class="modal" style="width:500px;">
      <div class="modal-head">
        <span>${id ? 'Edit Action' : 'New Action'}</span>
        <button class="modal-close" onclick="document.getElementById('actionModalOverlay').remove()">&times;</button>
      </div>
      <div class="modal-body">
        <label>What needs to be done?</label>
        <textarea id="actionDesc" style="min-height:80px;" placeholder="Describe the action or directive...">${esc(action.description)}</textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
          <div>
            <label>Status</label>
            <select id="actionStatus">
              <option value="pending" ${action.status === 'pending' ? 'selected' : ''}>‚óã Pending</option>
              <option value="in_progress" ${action.status === 'in_progress' ? 'selected' : ''}>‚ö° In Progress</option>
              <option value="done" ${action.status === 'done' ? 'selected' : ''}>‚úÖ Done</option>
            </select>
          </div>
          <div>
            <label>Priority</label>
            <select id="actionPriority">
              <option value="low" ${action.priority === 'low' ? 'selected' : ''}>Low</option>
              <option value="normal" ${action.priority === 'normal' ? 'selected' : ''}>Normal</option>
              <option value="high" ${action.priority === 'high' ? 'selected' : ''}>üî• High</option>
              <option value="urgent" ${action.priority === 'urgent' ? 'selected' : ''}>üö® Urgent</option>
            </select>
          </div>
        </div>
        ${action.mira_response ? `
          <label style="margin-top:12px;">Mira's Response</label>
          <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:0.82rem;color:var(--accent);line-height:1.5;">${esc(action.mira_response)}</div>
        ` : ''}
      </div>
      <div class="modal-foot">
        ${id ? `<button class="btn" style="margin-right:auto;color:var(--danger);" onclick="deleteAction(${id})">Delete</button>` : ''}
        <button class="btn" onclick="document.getElementById('actionModalOverlay').remove()">Cancel</button>
        <button class="btn primary" onclick="saveAction()">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function saveAction() {
  const data = {
    description: document.getElementById('actionDesc').value,
    status: document.getElementById('actionStatus').value,
    priority: document.getElementById('actionPriority').value
  };
  
  if (currentActionId) {
    await api('/api/actions/' + currentActionId, { method: 'PUT', body: JSON.stringify(data) });
  } else {
    await api('/api/actions', { method: 'POST', body: JSON.stringify(data) });
  }
  
  document.getElementById('actionModalOverlay').remove();
  loadNotes();
}

async function deleteAction(id) {
  if (!confirm('Delete this action?')) return;
  await api('/api/actions/' + id, { method: 'DELETE' });
  document.getElementById('actionModalOverlay').remove();
  loadNotes();
}

function renderNoteCard(n) {
  const catColor = n.category === 'strategy' ? 'var(--warning)' : 
                   n.category === 'outreach-templates' ? 'var(--success)' :
                   n.category === 'research' ? 'var(--purple)' : 'var(--accent)';
  const hasMiraResponse = n.mira_unread;
  return `
    <div class="note-card" data-category="${esc(n.category || 'general')}" data-mira-unread="${hasMiraResponse ? '1' : '0'}" style="background:var(--bg-card);border:1px solid ${hasMiraResponse ? 'var(--accent)' : 'var(--border)'};border-radius:var(--radius);padding:16px;cursor:pointer;transition:all 0.15s;${hasMiraResponse ? 'box-shadow:0 0 12px var(--accent-glow);' : ''}" onclick="openNoteModal(${n.id}, ${hasMiraResponse ? 'true' : 'false'})" onmouseover="this.style.borderColor='var(--border-hover)'" onmouseout="this.style.borderColor='${hasMiraResponse ? 'var(--accent)' : 'var(--border)'}'" >
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
        <h4 style="font-size:0.9rem;font-weight:600;line-height:1.3;flex:1;">${esc(n.title)}</h4>
        <div style="display:flex;gap:6px;align-items:center;">
          ${hasMiraResponse ? '<span style="background:var(--accent);color:white;font-size:0.6rem;padding:2px 8px;border-radius:10px;font-weight:600;animation:pulse 2s infinite;">üîÆ Mira replied</span>' : ''}
          ${n.pinned ? '<span style="color:var(--warning);font-size:0.8rem;">üìå</span>' : ''}
        </div>
      </div>
      <div style="font-size:0.72rem;color:${catColor};background:${catColor}15;padding:2px 8px;border-radius:4px;display:inline-block;margin-bottom:10px;">${esc(n.category || 'general')}</div>
      <div style="font-size:0.78rem;color:var(--text-dim);line-height:1.5;max-height:100px;overflow:hidden;white-space:pre-wrap;">${esc(n.content?.substring(0, 200) || '')}${n.content?.length > 200 ? '...' : ''}</div>
      <div style="font-size:0.65rem;color:var(--text-muted);margin-top:10px;">${fmtDate(n.created_at)}</div>
    </div>
  `;
}

function filterNotes() {
  const cat = document.getElementById('noteCategoryFilter').value;
  document.querySelectorAll('.note-card').forEach(card => {
    card.style.display = (!cat || card.dataset.category === cat) ? 'block' : 'none';
  });
}

let currentNoteId = null;
async function openNoteModal(id = null, hasMiraUnread = false) {
  currentNoteId = id;
  let note = { title: '', content: '', category: '', pinned: false, mira_unread: 0 };
  
  if (id) {
    try {
      const notes = await api('/api/notes');
      note = notes.find(n => n.id === id) || note;
      hasMiraUnread = note.mira_unread;
    } catch(e) {}
  }
  
  // Extract Mira responses for preview
  const miraResponses = [];
  if (note.content) {
    const lines = note.content.split('\n');
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].trim().startsWith('‚Üí MIRA')) {
        miraResponses.push(lines[i].trim());
      }
    }
  }
  
  const modal = document.createElement('div');
  modal.id = 'noteModalOverlay';
  modal.className = 'modal-overlay show';
  modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
  modal.innerHTML = `
    <div class="modal" style="width:650px;">
      <div class="modal-head">
        <span>${id ? 'Edit Note' : 'New Note'}</span>
        <button class="modal-close" onclick="document.getElementById('noteModalOverlay').remove()">&times;</button>
      </div>
      <div class="modal-body">
        ${hasMiraUnread ? `
          <div id="miraResponseBanner" style="background:linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(139,92,246,0.15) 100%);border:1px solid var(--accent);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:1.1rem;">üîÆ</span>
                <span style="font-size:0.82rem;font-weight:600;color:var(--accent);">New response from Mira</span>
              </div>
              <button onclick="markNoteRead(${id})" style="background:transparent;border:1px solid var(--accent);color:var(--accent);padding:3px 10px;border-radius:4px;font-size:0.68rem;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:4px;" onmouseover="this.style.background='var(--accent)';this.style.color='white'" onmouseout="this.style.background='transparent';this.style.color='var(--accent)'">‚òë Read</button>
            </div>
            <div style="font-size:0.78rem;color:var(--text);line-height:1.5;background:var(--bg-surface);border-radius:4px;padding:10px;max-height:120px;overflow-y:auto;">
              ${miraResponses.map(r => `<div style="margin-bottom:6px;">${esc(r)}</div>`).join('') || 'Response is in the content below.'}
            </div>
          </div>
        ` : ''}
        <label>Title</label>
        <input type="text" id="noteTitle" value="${esc(note.title)}" placeholder="e.g., LinkedIn Outreach ‚Äî CIO Reconnection">
        <label>Category</label>
        <input type="text" id="noteCategory" value="${esc(note.category || '')}" placeholder="e.g., outreach-templates, strategy, research">
        <label>Content <span style="font-size:0.7rem;color:var(--text-muted);font-weight:normal;">Use @Mira: to request research or actions</span></label>
        <textarea id="noteContent" style="min-height:220px;font-family:monospace;font-size:0.8rem;" placeholder="Note content...&#10;&#10;Use @Mira: to request research or actions">${esc(note.content || '')}</textarea>
        <label style="display:flex;align-items:center;gap:8px;margin-top:14px;">
          <input type="checkbox" id="notePinned" ${note.pinned ? 'checked' : ''} style="width:auto;">
          Pin this note
        </label>
      </div>
      <div class="modal-foot">
        ${id ? `<button class="btn" style="margin-right:auto;color:var(--danger);" onclick="deleteNote(${id})">Delete</button>` : ''}
        <button class="btn" onclick="document.getElementById('noteModalOverlay').remove()">Cancel</button>
        <button class="btn primary" onclick="saveNote()">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Don't auto-mark as read - wait for explicit acknowledgment
}

async function markNoteRead(noteId) {
  await api('/api/notes/' + noteId + '/mark-read', { method: 'POST' });
  const banner = document.getElementById('miraResponseBanner');
  if (banner) {
    banner.style.transition = 'all 0.3s';
    banner.style.opacity = '0';
    banner.style.transform = 'translateY(-10px)';
    setTimeout(() => banner.remove(), 300);
  }
  // Update the card in the background (remove badge) without closing modal
  loadNotes();
}

async function saveNote() {
  const data = {
    title: document.getElementById('noteTitle').value,
    content: document.getElementById('noteContent').value,
    category: document.getElementById('noteCategory').value || 'general',
    pinned: document.getElementById('notePinned').checked ? 1 : 0
  };
  
  if (currentNoteId) {
    await api('/api/notes/' + currentNoteId, { method: 'PUT', body: JSON.stringify(data) });
  } else {
    await api('/api/notes', { method: 'POST', body: JSON.stringify(data) });
  }
  
  document.getElementById('noteModalOverlay').remove();
  loadNotes();
}

async function deleteNote(id) {
  if (!confirm('Delete this note?')) return;
  await api('/api/notes/' + id, { method: 'DELETE' });
  document.getElementById('noteModalOverlay').remove();
  loadNotes();
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function fmtDate(d) {
  if(!d) return '';
  const dt = new Date(d+'Z');
  const now = new Date();
  const diff = now - dt;
  if(diff < 86400000) return 'Today';
  if(diff < 172800000) return 'Yesterday';
  return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

// ‚îÄ‚îÄ Mira Status Polling (sidebar dot) ‚îÄ‚îÄ
async function pollMiraStatus() {
  const dot = document.getElementById('miraDotSm');
  if (!dot) return;
  try {
    const r = await fetch(API + '/api/mira/status');
    const d = await r.json();
    dot.className = 'mira-dot-sm ' + d.state;
  } catch(e) {
    dot.className = 'mira-dot-sm offline';
  }
}
pollMiraStatus();
setInterval(pollMiraStatus, 5000);

// ‚îÄ‚îÄ Advisor Ticker (dynamic rotation) ‚îÄ‚îÄ
let tickerTips = [];
let tickerIdx = 0;
async function loadAdvisorTips() {
  try {
    const r = await fetch(API + '/api/advisor/tip');
    const d = await r.json();
    if (d.tips && d.tips.length) tickerTips = d.tips;
  } catch(e) {}
}
function showNextTip() {
  if (!tickerTips.length) return;
  const track = document.getElementById('tickerTrack');
  const tip = tickerTips[tickerIdx % tickerTips.length];
  track.innerHTML = `<span class="ticker-text ticker-fade-in">${tip}</span>`;
  tickerIdx++;
}
loadAdvisorTips().then(() => { showNextTip(); });
setInterval(() => { loadAdvisorTips(); }, 120000); // fetch new tips every 2 min
setInterval(showNextTip, 12000); // rotate tip every 12 sec

// ‚îÄ‚îÄ Sidebar Chat (OpenClaw Gateway WebSocket) ‚îÄ‚îÄ
const _isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
const CHAT_WS_URL = _isLocal ? 'ws://127.0.0.1:18789' : 'wss://app.heymira.app';
const CHAT_TOKEN = '88a82af55b41cdc3372ba46ef93ed4f2ebf366637444932c';
let chatWs = null;
let chatConnected = false;
let chatSessionKey = 'agent:main:main'; // main session
let chatPending = new Map();

function _uid() { return Math.random().toString(36).slice(2,10) + Date.now().toString(36); }

function addChatMsg(text, sender) {
  const box = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.style.cssText = sender === 'user'
    ? 'align-self:flex-end;background:var(--accent);color:white;padding:6px 10px;border-radius:10px 10px 2px 10px;font-size:0.78rem;max-width:85%;word-wrap:break-word;line-height:1.4;'
    : 'align-self:flex-start;background:var(--bg-surface);border:1px solid var(--border);color:var(--text-dim);padding:6px 10px;border-radius:10px 10px 10px 2px;font-size:0.78rem;max-width:85%;word-wrap:break-word;line-height:1.4;';
  div.innerHTML = esc(text).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function addTypingIndicator() {
  removeTypingIndicator();
  const box = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.id = 'typingDots';
  div.style.cssText = 'align-self:flex-start;color:var(--text-muted);font-size:0.78rem;padding:4px 0;';
  div.textContent = 'üîÆ thinking...';
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function removeTypingIndicator() {
  const el = document.getElementById('typingDots');
  if (el) el.remove();
}

function updateChatStatus(state) {
  const dot = document.getElementById('miraDotSm');
  if (dot) dot.className = 'mira-dot-sm ' + state;
}

function wsSend(method, params) {
  const id = _uid();
  return new Promise((resolve, reject) => {
    if (!chatWs || chatWs.readyState !== 1) return reject(new Error('not connected'));
    chatPending.set(id, { resolve, reject });
    chatWs.send(JSON.stringify({ type: 'req', id, method, params }));
    setTimeout(() => { if (chatPending.has(id)) { chatPending.delete(id); reject(new Error('timeout')); } }, 120000);
  });
}

function extractText(msg) {
  if (!msg) return '';
  if (typeof msg === 'string') return msg;
  if (typeof msg.content === 'string') return msg.content;
  if (Array.isArray(msg.content)) return msg.content.filter(c => c.type === 'text').map(c => c.text).join('\n');
  if (typeof msg.text === 'string') return msg.text;
  return '';
}

function connectChat() {
  if (chatWs && chatWs.readyState <= 1) return;
  try { chatWs = new WebSocket(CHAT_WS_URL); } catch(e) { updateChatStatus('offline'); return; }

  chatWs.onopen = () => { console.log('[chat] ws open'); };

  chatWs.onmessage = (ev) => {
    let msg;
    try { msg = JSON.parse(ev.data); } catch { return; }

    // Handle responses to our requests
    if (msg.type === 'res') {
      const cb = chatPending.get(msg.id);
      if (cb) {
        chatPending.delete(msg.id);
        msg.ok ? cb.resolve(msg.payload) : cb.reject(new Error(msg.error?.message || 'request failed'));
      }
      return;
    }

    // Handle events
    if (msg.type === 'event') {
      if (msg.event === 'connect.challenge') {
        wsSend('connect', {
          minProtocol: 3, maxProtocol: 3,
          client: { id: 'webchat-ui', version: '1.0', platform: 'web', mode: 'webchat' },
          role: 'operator', scopes: [],
          auth: { token: CHAT_TOKEN },
          caps: []
        }).then(res => {
          chatConnected = true;
          // Get session key from snapshot
          const sk = res?.snapshot?.sessionDefaults?.mainSessionKey;
          if (sk) chatSessionKey = sk;
          updateChatStatus('idle');
          console.log('[chat] connected, session:', chatSessionKey);
          loadChatHistory();
        }).catch(e => {
          console.error('[chat] connect failed', e);
          updateChatStatus('offline');
        });
        return;
      }

      if (msg.event === 'chat') {
        const p = msg.payload;
        if (!p) return;
        if (p.state === 'delta') {
          updateChatStatus('working');
          addTypingIndicator();
        } else if (p.state === 'final') {
          removeTypingIndicator();
          updateChatStatus('idle');
          loadChatHistory();
        } else if (p.state === 'error' || p.state === 'aborted') {
          removeTypingIndicator();
          updateChatStatus('idle');
        }
        return;
      }
      // Ignore other events (tick, health, presence, etc.)
      return;
    }
  };

  chatWs.onclose = () => {
    chatConnected = false;
    updateChatStatus('offline');
    setTimeout(connectChat, 5000);
  };
  chatWs.onerror = (e) => { console.error('[chat] ws error', e); };
}

async function loadChatHistory() {
  try {
    const res = await wsSend('chat.history', { sessionKey: chatSessionKey, limit: 15 });
    const messages = res?.messages || [];
    const box = document.getElementById('chatMessages');
    box.innerHTML = '';
    messages.forEach(m => {
      const txt = extractText(m);
      if (!txt || txt === 'NO_REPLY' || txt === 'HEARTBEAT_OK') return;
      if (m.role === 'user') addChatMsg(txt, 'user');
      else if (m.role === 'assistant') addChatMsg(txt, 'mira');
    });
    if (!box.children.length) addChatMsg('Hey Sean üîÆ What can I help with?', 'mira');
  } catch(e) {
    console.error('[chat] history error', e);
  }
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  if (!chatConnected) {
    addChatMsg('Mira is offline ‚Äî reconnecting...', 'mira');
    connectChat();
    return;
  }
  input.value = '';
  addChatMsg(msg, 'user');
  addTypingIndicator();
  wsSend('chat.send', {
    sessionKey: chatSessionKey,
    message: msg,
    deliver: false,
    idempotencyKey: _uid()
  }).catch(e => {
    removeTypingIndicator();
    addChatMsg('Error: ' + e.message, 'mira');
  });
}

connectChat();

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadDashboard();
api('/api/leads').then(l => document.getElementById('leads-badge').textContent = l.length);
api('/api/pipeline').then(deals => {
  const activeDeals = deals.filter(d => d.stage !== 'won' && d.stage !== 'lost');
  document.getElementById('pipeline-badge').textContent = activeDeals.length;
});

// ‚îÄ‚îÄ Global Search ‚îÄ‚îÄ
let searchTimeout = null;
let searchResults = [];
let selectedSearchIndex = -1;

async function handleGlobalSearch(query) {
  const resultsDiv = document.getElementById('searchResults');
  
  if (!query || query.length < 2) {
    resultsDiv.innerHTML = '<div style="padding:16px;color:var(--text-muted);font-size:0.78rem;text-align:center;">Type to search tasks, notes, CIOs, deals...</div>';
    return;
  }
  
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      const data = await api('/api/search?q=' + encodeURIComponent(query));
      searchResults = data.results || [];
      selectedSearchIndex = -1;
      renderSearchResults();
    } catch(e) {
      resultsDiv.innerHTML = '<div style="padding:16px;color:var(--danger);">Search error</div>';
    }
  }, 150);
}

function renderSearchResults() {
  const resultsDiv = document.getElementById('searchResults');
  
  if (!searchResults.length) {
    resultsDiv.innerHTML = '<div style="padding:16px;color:var(--text-muted);font-size:0.78rem;text-align:center;">No results found</div>';
    return;
  }
  
  // Group by type
  const grouped = {};
  searchResults.forEach(r => {
    if (!grouped[r.type]) grouped[r.type] = [];
    grouped[r.type].push(r);
  });
  
  const typeLabels = {
    task: 'üìã Tasks',
    note: 'üìù Notes', 
    cio: 'üè• CIO Targets',
    deal: 'üí∞ Pipeline',
    action: 'üéØ Actions',
    lead: 'üî• Leads'
  };
  
  let html = '';
  let globalIndex = 0;
  
  for (const [type, items] of Object.entries(grouped)) {
    html += `<div style="padding:8px 12px;font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;background:var(--bg-surface);border-bottom:1px solid var(--border);">${typeLabels[type] || type}</div>`;
    items.forEach(item => {
      const isSelected = globalIndex === selectedSearchIndex;
      html += `
        <div class="search-result" data-index="${globalIndex}" onclick="selectSearchResult(${globalIndex})" 
          style="padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);${isSelected ? 'background:var(--accent-glow);' : ''}"
          onmouseover="this.style.background='var(--bg-surface)'" onmouseout="this.style.background='${isSelected ? 'var(--accent-glow)' : 'transparent'}'">
          <span style="font-size:1rem;">${item.icon}</span>
          <div style="flex:1;min-width:0;">
            <div style="font-size:0.82rem;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(item.title)}</div>
            <div style="font-size:0.7rem;color:var(--text-muted);">${esc(item.subtitle)}</div>
          </div>
          <span style="font-size:0.65rem;color:var(--text-muted);">‚Üµ</span>
        </div>
      `;
      globalIndex++;
    });
  }
  
  resultsDiv.innerHTML = html;
}

function selectSearchResult(index) {
  const result = searchResults[index];
  if (!result) return;
  
  closeSearch();
  
  // Navigate based on type
  switch(result.type) {
    case 'task':
      showPage('dashboard', document.querySelector('.nav-item'));
      setTimeout(() => openQuickPanel(result.id), 300);
      break;
    case 'note':
      showPage('notes', document.querySelectorAll('.nav-item')[10]);
      setTimeout(() => openNoteModal(result.id), 300);
      break;
    case 'cio':
      showPage('pipeline', document.querySelectorAll('.nav-item')[1]);
      setTimeout(() => editCIO(result.id), 300);
      break;
    case 'deal':
      showPage('sales_pipeline', document.querySelectorAll('.nav-item')[2]);
      setTimeout(() => editDeal(result.id), 300);
      break;
    case 'action':
      showPage('notes', document.querySelectorAll('.nav-item')[10]);
      setTimeout(() => openActionModal(result.id), 300);
      break;
    case 'lead':
      showPage('leads', document.querySelectorAll('.nav-item')[4]);
      break;
  }
}

function closeSearch() {
  document.getElementById('globalSearch').value = '';
  document.getElementById('searchResults').style.display = 'none';
  searchResults = [];
  selectedSearchIndex = -1;
}

// Keyboard navigation
document.addEventListener('keydown', e => {
  const searchInput = document.getElementById('globalSearch');
  const resultsDiv = document.getElementById('searchResults');
  
  // ‚åòK or Ctrl+K to focus search
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    searchInput.focus();
    resultsDiv.style.display = 'block';
    return;
  }
  
  // If search is focused
  if (document.activeElement === searchInput) {
    if (e.key === 'Escape') {
      closeSearch();
      searchInput.blur();
      return;
    }
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedSearchIndex = Math.min(selectedSearchIndex + 1, searchResults.length - 1);
      renderSearchResults();
      return;
    }
    
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedSearchIndex = Math.max(selectedSearchIndex - 1, 0);
      renderSearchResults();
      return;
    }
    
    if (e.key === 'Enter' && selectedSearchIndex >= 0) {
      e.preventDefault();
      selectSearchResult(selectedSearchIndex);
      return;
    }
  }
});

// Close search when clicking outside
document.addEventListener('click', e => {
  const searchContainer = document.getElementById('globalSearch')?.parentElement;
  if (searchContainer && !searchContainer.contains(e.target)) {
    document.getElementById('searchResults').style.display = 'none';
  }
});

// ‚îÄ‚îÄ Quick Panel (Task Slide-out) ‚îÄ‚îÄ
let quickPanelTaskId = null;
let quickPanelTask = null;

function openQuickPanel(taskId, hasMiraUnread = false) {
  quickPanelTaskId = taskId;
  api('/api/tasks/' + taskId).then(task => {
    if (!task) return;
    quickPanelTask = task;
    hasMiraUnread = task.mira_unread;
    let tags = [];
    try { tags = JSON.parse(task.tags || '[]'); if (!Array.isArray(tags)) tags = []; } catch(e) { tags = []; }
    
    const panel = document.getElementById('quickPanel');
    const overlay = document.getElementById('quickPanelOverlay');
    
    // Show Mira banner if unread
    const miraBanner = document.getElementById('qpMiraBanner');
    if (hasMiraUnread && task.notes) {
      miraBanner.style.display = 'block';
      miraBanner.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:1rem;">üîÆ</span>
            <span style="font-size:0.78rem;font-weight:600;color:var(--accent);">Mira added notes</span>
          </div>
          <button onclick="markTaskRead(${taskId})" style="background:transparent;border:1px solid var(--accent);color:var(--accent);padding:3px 8px;border-radius:4px;font-size:0.65rem;cursor:pointer;font-weight:500;" onmouseover="this.style.background='var(--accent)';this.style.color='white'" onmouseout="this.style.background='transparent';this.style.color='var(--accent)'">‚òë Read</button>
        </div>
        <div style="font-size:0.75rem;color:var(--text);line-height:1.4;max-height:80px;overflow-y:auto;">${esc(task.notes).substring(0, 200)}${task.notes.length > 200 ? '...' : ''}</div>
      `;
    } else {
      miraBanner.style.display = 'none';
    }
    
    document.getElementById('qpTitle').value = task.title || '';
    document.getElementById('qpDescription').value = task.description || '';
    document.getElementById('qpNotes').value = task.notes || '';
    document.getElementById('qpPriority').value = task.priority || 'normal';
    document.getElementById('qpDueDate').value = task.due_date ? task.due_date.split('T')[0] : '';
    
    // Status buttons
    document.querySelectorAll('.qp-status-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.status === task.status);
    });
    
    // Tags display
    document.getElementById('qpTagsDisplay').innerHTML = tags.map(t => 
      `<span class="qp-tag" style="background:var(--accent-glow);color:var(--accent);">${esc(t)}</span>`
    ).join('') || '<span style="color:var(--text-muted);font-size:0.75rem;">No tags</span>';
    
    // Meta info
    document.getElementById('qpMeta').innerHTML = `Created: ${fmtDate(task.created_at)} ¬∑ Updated: ${fmtDate(task.updated_at)}`;
    
    panel.classList.add('open');
    overlay.classList.add('open');
    
    // Don't auto-mark as read - wait for explicit acknowledgment
    
    // Focus notes for quick editing
    setTimeout(() => document.getElementById('qpNotes').focus(), 300);
  });
}

async function markTaskRead(taskId) {
  await api('/api/tasks/' + taskId + '/mark-read', { method: 'POST' });
  const banner = document.getElementById('qpMiraBanner');
  if (banner) {
    banner.style.transition = 'all 0.3s';
    banner.style.opacity = '0';
    setTimeout(() => { banner.style.display = 'none'; }, 300);
  }
  // Refresh dashboard in background
  loadDashboard();
}

function closeQuickPanel() {
  document.getElementById('quickPanel').classList.remove('open');
  document.getElementById('quickPanelOverlay').classList.remove('open');
  quickPanelTaskId = null;
  quickPanelTask = null;
}

function qpSetStatus(status) {
  document.querySelectorAll('.qp-status-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.status === status);
  });
}

async function qpSave() {
  if (!quickPanelTaskId) return;
  const activeStatus = document.querySelector('.qp-status-btn.active');
  const data = {
    title: document.getElementById('qpTitle').value,
    description: document.getElementById('qpDescription').value,
    notes: document.getElementById('qpNotes').value,
    priority: document.getElementById('qpPriority').value,
    due_date: document.getElementById('qpDueDate').value || null,
    status: activeStatus ? activeStatus.dataset.status : quickPanelTask.status
  };
  await api('/api/tasks/' + quickPanelTaskId, { method: 'PUT', body: JSON.stringify(data) });
  closeQuickPanel();
  loadDashboard();
}

async function qpMarkDone() {
  if (!quickPanelTaskId) return;
  // Save any current changes + mark as done
  const data = {
    title: document.getElementById('qpTitle').value,
    description: document.getElementById('qpDescription').value,
    notes: document.getElementById('qpNotes').value,
    priority: document.getElementById('qpPriority').value,
    due_date: document.getElementById('qpDueDate').value || null,
    status: 'done'
  };
  await api('/api/tasks/' + quickPanelTaskId, { method: 'PUT', body: JSON.stringify(data) });
  closeQuickPanel();
  loadDashboard();
}

async function qpDelete() {
  if (!quickPanelTaskId || !confirm('Delete this task?')) return;
  await api('/api/tasks/' + quickPanelTaskId, { method: 'DELETE' });
  closeQuickPanel();
  loadDashboard();
}

// Keyboard shortcuts for quick panel
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && document.getElementById('quickPanel').classList.contains('open')) {
    closeQuickPanel();
  }
  if ((e.metaKey || e.ctrlKey) && e.key === 's' && document.getElementById('quickPanel').classList.contains('open')) {
    e.preventDefault();
    qpSave();
  }
});
</script>

<!-- Quick Panel (slide-out for tasks) -->
<!-- Lead Panel (slide-out) -->
<div class="quick-panel-overlay" id="leadPanelOverlay" onclick="closeLeadPanel()"></div>
<div class="quick-panel" id="leadPanel">
  <div class="quick-panel-header">
    <h3>üéØ Lead Details</h3>
    <button class="quick-panel-close" onclick="closeLeadPanel()">√ó</button>
  </div>
  <div class="quick-panel-body">
    <div id="lpMiraBanner" style="display:none;background:linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(139,92,246,0.15) 100%);border:1px solid var(--accent);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:14px;"></div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="qp-field"><label>Name</label><input type="text" id="lpName"></div>
      <div class="qp-field"><label>Title</label><input type="text" id="lpTitle"></div>
    </div>
    <div class="qp-field"><label>Organization</label><input type="text" id="lpOrg"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="qp-field"><label>Email</label><input type="email" id="lpEmail"></div>
      <div class="qp-field"><label>LinkedIn</label><input type="text" id="lpLinkedin" placeholder="linkedin.com/in/..."></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="qp-field"><label>Region</label>
        <select id="lpRegion">
          <option value="ontario">üçÅ Ontario</option>
          <option value="canada">üá®üá¶ Canada</option>
          <option value="us">üá∫üá∏ US</option>
          <option value="uk">üá¨üáß UK</option>
          <option value="other">üåç Other</option>
        </select>
      </div>
      <div class="qp-field"><label>Status</label>
        <select id="lpStatus">
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="meeting">Meeting</option>
          <option value="nurture">Nurture</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <div class="qp-field"><label>Interest</label><input type="text" id="lpInterest" placeholder="AI, Digital..."></div>
    </div>
    <div class="qp-field"><label>Next Action</label><input type="text" id="lpNextAction" placeholder="What's the next step?"></div>
    <div class="qp-field"><label>Proposed Outreach</label><textarea id="lpOutreach" style="min-height:80px;" placeholder="Draft message to send..."></textarea></div>
    <div class="qp-field"><label>Your Notes <span style="color:var(--text-muted);font-weight:normal;">(use @Mira: for research requests)</span></label><textarea id="lpNotes" style="min-height:100px;" placeholder="Background, context, @Mira: requests..."></textarea></div>
    <div class="qp-field"><label>üîÆ Mira's Research</label><div id="lpMiraNotes"></div></div>
  </div>
  <div class="quick-panel-footer">
    <button class="btn" style="color:var(--danger);" onclick="deleteLeadPanel()">Delete</button>
    <div style="display:flex;gap:8px;">
      <button class="btn" onclick="closeLeadPanel()">Cancel</button>
      <button class="btn primary" onclick="saveLeadPanel()">Save</button>
    </div>
  </div>
</div>

<div class="quick-panel-overlay" id="quickPanelOverlay" onclick="closeQuickPanel()"></div>
<div class="quick-panel" id="quickPanel">
  <div class="quick-panel-header">
    <h3>üìã Task Details</h3>
    <button class="quick-panel-close" onclick="closeQuickPanel()">√ó</button>
  </div>
  <div class="quick-panel-body">
    <div id="qpMiraBanner" style="display:none;background:linear-gradient(135deg, rgba(59,130,246,0.15) 0%, rgba(139,92,246,0.15) 100%);border:1px solid var(--accent);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:14px;"></div>
    <div class="qp-field">
      <label>Title</label>
      <input type="text" id="qpTitle" placeholder="Task title...">
    </div>
    <div class="qp-field">
      <label>Status</label>
      <div class="qp-status-row">
        <button class="qp-status-btn" data-status="todo" onclick="qpSetStatus('todo')">üìã To Do</button>
        <button class="qp-status-btn" data-status="in_progress" onclick="qpSetStatus('in_progress')">‚ö° In Progress</button>
        <button class="qp-status-btn" data-status="done" onclick="qpSetStatus('done')">‚úÖ Done</button>
        <button class="qp-status-btn" data-status="backlog" onclick="qpSetStatus('backlog')">üí° Ideas</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
      <div class="qp-field" style="margin-bottom:0;">
        <label>Priority</label>
        <select id="qpPriority">
          <option value="low">Low</option>
          <option value="normal">Normal</option>
          <option value="high">üî• High</option>
          <option value="urgent">üö® Urgent</option>
        </select>
      </div>
      <div class="qp-field" style="margin-bottom:0;">
        <label>Due Date</label>
        <input type="date" id="qpDueDate">
      </div>
    </div>
    <div class="qp-field">
      <label>Objective</label>
      <textarea id="qpDescription" placeholder="What are we trying to accomplish? Paste links, details, context..." style="min-height:140px;font-size:0.82rem;"></textarea>
    </div>
    <div class="qp-field" style="flex:1;">
      <label>Notes <span style="color:var(--text-muted);font-weight:normal;">(updates, blockers, @Mira: requests)</span></label>
      <textarea id="qpNotes" placeholder="Add notes, progress updates, blockers...&#10;&#10;Use @Mira: to request research or action" style="min-height:160px;flex:1;"></textarea>
    </div>
    <div class="qp-field">
      <label>Tags</label>
      <div id="qpTagsDisplay" class="qp-tags"></div>
    </div>
    <div class="qp-meta" id="qpMeta"></div>
  </div>
  <div class="quick-panel-footer">
    <button class="btn" style="color:var(--danger);" onclick="qpDelete()">Delete</button>
    <div style="display:flex;gap:8px;">
      <button class="btn" onclick="closeQuickPanel()">Cancel</button>
      <button class="btn" style="background:var(--success);border-color:var(--success);color:white;" onclick="qpMarkDone()">‚úì Done</button>
      <button class="btn primary" onclick="qpSave()">Save <span style="opacity:0.7;font-size:0.7rem;">‚åòS</span></button>
    </div>
  </div>
</div>

<!-- Deal Guidance Panel -->
<div class="quick-panel" id="dealGuidancePanel">
  <div class="quick-panel-header">
    <h3>üíº <span id="dgpOrg">Deal</span></h3>
    <button class="quick-panel-close" onclick="closeDealGuidance()">√ó</button>
  </div>
  <div class="quick-panel-body" id="dgpBody"></div>
  <div class="quick-panel-footer">
    <button class="btn" onclick="closeDealGuidance()">Close</button>
    <button class="btn primary" onclick="editDealFromGuidance()">Edit Deal Details</button>
  </div>
</div>
<div class="quick-panel-overlay" id="dealGuidanceOverlay" onclick="closeDealGuidance()"></div>

<script src="/deal-guidance.js?v=2"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEAL GUIDANCE PANEL UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentGuidanceDealId = null;

// Edit Deal - Opens prescriptive guidance panel (called from deal cards)
async function editDeal(id) {
  console.log('editDeal called with id:', id);
  try {
    await showDealGuidance(id);
  } catch(e) {
    console.error('Error in showDealGuidance:', e);
    alert('Error loading deal: ' + e.message);
  }
}

async function showDealGuidance(dealId) {
  currentGuidanceDealId = dealId;
  const deal = await api('/api/pipeline/' + dealId);
  const guidance = generateDealGuidance(deal);
  
  document.getElementById('dgpOrg').textContent = deal.organization || 'Deal';
  
  const stageIndex = ['outreach','teach','qualify','expand','propose','close','won'].indexOf(deal.stage);
  const stageLabels = ['Outreach','Teach','Qualify','Expand','Propose','Close','Won'];
  
  let html = '';
  
  // Stage Progress Bar
  html += '<div style="margin-bottom:20px;">';
  html += '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">CHALLENGER STAGE</div>';
  html += '<div style="display:flex;gap:4px;">';
  stageLabels.forEach((s, i) => {
    const isActive = i === stageIndex;
    const isPast = i < stageIndex;
    const bg = isActive ? 'var(--accent)' : isPast ? 'var(--success)' : 'var(--bg-surface)';
    const color = isActive || isPast ? 'white' : 'var(--text-muted)';
    html += '<div style="flex:1;padding:8px 4px;background:'+bg+';color:'+color+';text-align:center;font-size:0.65rem;font-weight:600;border-radius:4px;">'+s+'</div>';
  });
  html += '</div></div>';
  
  // Next Best Action (prominent)
  if (guidance.nextBestAction) {
    html += '<div style="background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(139,92,246,0.15));border:1px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:20px;">';
    html += '<div style="font-size:0.7rem;color:var(--accent);font-weight:600;margin-bottom:6px;">üéØ NEXT BEST ACTION</div>';
    html += '<div style="font-size:0.95rem;font-weight:600;color:var(--text);margin-bottom:4px;">'+esc(guidance.nextBestAction.message)+'</div>';
    html += '<div style="font-size:0.85rem;color:var(--text-dim);">'+esc(guidance.nextBestAction.action)+'</div>';
    html += '</div>';
  }
  
  // Warnings
  if (guidance.warnings.length) {
    html += '<div style="margin-bottom:20px;">';
    html += '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">‚ö†Ô∏è ATTENTION REQUIRED</div>';
    guidance.warnings.forEach(w => {
      const borderColor = w.severity === 'critical' ? 'var(--danger)' : w.severity === 'high' ? 'var(--warning)' : 'var(--text-muted)';
      html += '<div style="border-left:3px solid '+borderColor+';padding:10px 12px;margin-bottom:8px;background:var(--bg-surface);border-radius:0 8px 8px 0;">';
      html += '<div style="font-size:0.8rem;font-weight:500;color:var(--text);">'+esc(w.message)+'</div>';
      html += '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:4px;">‚Üí '+esc(w.action)+'</div>';
      html += '</div>';
    });
    html += '</div>';
  }
  
  // MEDDPICC Scorecard
  html += '<div style="margin-bottom:20px;">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">';
  html += '<div style="font-size:0.75rem;color:var(--text-muted);">MEDDPICC SCORECARD</div>';
  const scoreColor = guidance.meddpiccScore >= 70 ? 'var(--success)' : guidance.meddpiccScore >= 40 ? 'var(--warning)' : 'var(--danger)';
  html += '<div style="font-size:0.85rem;font-weight:700;color:'+scoreColor+';">'+guidance.meddpiccScore+'%</div>';
  html += '</div>';
  
  Object.keys(MEDDPICC).forEach(field => {
    const status = guidance.meddpiccStatus[field];
    const icon = status.filled ? '‚úÖ' : '‚¨ú';
    const color = status.filled ? 'var(--text)' : 'var(--text-muted)';
    html += '<div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick="toggleMeddpiccDetail(this)">';
    html += '<span style="font-size:0.9rem;">'+icon+'</span>';
    html += '<div style="flex:1;">';
    html += '<div style="font-size:0.8rem;font-weight:500;color:'+color+';"><span style="color:var(--accent);font-weight:700;">'+status.letter+'</span> '+status.label+'</div>';
    if (status.filled) {
      html += '<div style="font-size:0.75rem;color:var(--text-dim);margin-top:2px;">'+esc(status.value.substring(0,80))+(status.value.length>80?'...':'')+'</div>';
    }
    html += '<div class="meddpicc-detail" style="display:none;margin-top:8px;padding:10px;background:var(--bg-card);border-radius:8px;font-size:0.75rem;">';
    html += '<div style="color:var(--accent);margin-bottom:4px;">'+esc(status.question)+'</div>';
    html += '<div style="color:var(--text-muted);margin-bottom:4px;font-style:italic;">Examples: '+esc(status.examples)+'</div>';
    html += '<div style="color:var(--text-dim);">üí° '+esc(status.coaching)+'</div>';
    html += '</div>';
    html += '</div></div>';
  });
  html += '</div>';
  
  // Stage Guidance
  html += '<div style="margin-bottom:20px;">';
  html += '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">üìã STAGE PLAYBOOK: '+guidance.stageGuidance.label.toUpperCase()+'</div>';
  html += '<div style="font-size:0.8rem;color:var(--accent);margin-bottom:10px;font-weight:500;">Objective: '+esc(guidance.stageGuidance.objective)+'</div>';
  guidance.stageGuidance.actions.forEach((action, i) => {
    html += '<div style="display:flex;gap:8px;margin-bottom:8px;">';
    html += '<span style="color:var(--text-muted);font-size:0.75rem;">'+(i+1)+'.</span>';
    html += '<span style="font-size:0.8rem;color:var(--text-dim);">'+esc(action)+'</span>';
    html += '</div>';
  });
  html += '<div style="margin-top:12px;padding:10px;background:var(--bg-surface);border-radius:8px;">';
  html += '<div style="font-size:0.7rem;color:var(--success);font-weight:600;">TO ADVANCE ‚Üí</div>';
  html += '<div style="font-size:0.8rem;color:var(--text-dim);">'+esc(guidance.stageGuidance.nextStageRequires)+'</div>';
  html += '</div>';
  html += '</div>';
  
  // Deal Info
  html += '<div style="border-top:1px solid var(--border);padding-top:16px;">';
  html += '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">DEAL INFO</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.8rem;">';
  html += '<div><span style="color:var(--text-muted);">Value:</span> <strong>$'+(deal.deal_value||0).toLocaleString()+'</strong></div>';
  html += '<div><span style="color:var(--text-muted);">Type:</span> '+esc(deal.engagement_type||'N/A')+'</div>';
  html += '<div><span style="color:var(--text-muted);">Days in Stage:</span> '+esc(deal.days_in_stage||'?')+'</div>';
  html += '<div><span style="color:var(--text-muted);">Next Action:</span> '+(deal.next_action_date||'Not set')+'</div>';
  html += '</div>';
  if (deal.notes) {
    html += '<div style="margin-top:12px;padding:10px;background:var(--bg-surface);border-radius:8px;font-size:0.75rem;color:var(--text-dim);white-space:pre-wrap;">'+esc(deal.notes)+'</div>';
  }
  html += '</div>';
  
  document.getElementById('dgpBody').innerHTML = html;
  document.getElementById('dealGuidancePanel').classList.add('open');
  document.getElementById('dealGuidanceOverlay').classList.add('open');
}

function closeDealGuidance() {
  document.getElementById('dealGuidancePanel').classList.remove('open');
  document.getElementById('dealGuidanceOverlay').classList.remove('open');
  currentGuidanceDealId = null;
}

function editDealFromGuidance() {
  closeDealGuidance();
  if (currentGuidanceDealId) showDealModal(currentGuidanceDealId);
}

function toggleMeddpiccDetail(el) {
  const detail = el.querySelector('.meddpicc-detail');
  if (detail) {
    detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
  }
}

// Override editDeal to show guidance panel instead of modal
const originalEditDeal = typeof editDeal === 'function' ? editDeal : null;
editDeal = function(id) {
  showDealGuidance(id);
};
</script>
</body>
</html>
